## Локально‑первый AI‑ассистент: расширенный архитектурный план (революционно, но реалистично)

### 1) Северная звезда UX
- **Мгновенная полезность**: первые 5 минут — готовность решить реальную задачу без настройки.
- **План → Предпросмотр → Выполнение**: всегда виден план действий, дифф/симуляция изменений, один клик до выполнения.
- **Искренность и предсказуемость**: детерминизм инструментов, прозрачные разрешения и последствия.
- **Ненавязчивость**: ассистент работает в фоне, предлагает контекстные подсказки, но не мешает.
- **Сценарная мощь**: «сборки/flows» решают большие задачи (код, 3D, инженерка) без микроменеджмента.

### 2) Персоны и целевые пути
- **Разработчик**: код, рефакторинг, документация, миграции, CI/CD, ревью диффов.
- **Инженер/Дизайнер**: CAD → конвертация → визуализация → отчёты.
- **Проектный менеджер/Создатель**: план задач, резюме, отчёты, коммуникации.
- **Повернутый на приватности**: работа оффлайн/локально, прозрачность и контроль.

### 3) Архитектурный обзор 2.0
- **Слои**
  - Domain (чистое ядро): `Task`, `Intent`, `Plan`, `ToolSpec`, `MemoryRecord`, `Capability`, контракты `Tool`, `LlmClient`, `VectorIndex`, `DocStore`, `Policy`.
  - Application: мульти‑агентная оркестрация (Planner/Executor/Critic/Scheduler), use‑cases (`chat`, `smart`, `tool`, `tasks`, `memory`, `models`).
  - Adapters: LLM провайдеры (локальные/облачные), рантайм инструментов (WASI/subprocess), память (HNSW+SQLite+Qwen3 rerank), OS‑интеграции.
  - Infrastructure: конфиг‑профили, логирование/трейсинг, TUI/CLI, песочница, обновления/подписи, менеджер моделей.
- **Событийная шина**: внутренний EventBus (topics: `intent`, `plan`, `tool.invoked`, `fs.diff`, `memory.upsert`, `policy.block`, `job.progress`, `llm.tokens`, `error`), backpressure.
- **Actor‑модель**: каждый компонент — актор (Tokio), отчётливые границы, ретраи, таймауты, бюджет.

### 4) Мульти‑агентные циклы (реально полезные)
- **IntentAnalyzer**: классификация/извлечение слотов (LLM + эвристики без тренировки), защита JSON‑контрактами.
- **Planner**: строит `ActionPlan` (с пояснениями, зависимостями, параллельными группами), умеет использовать рецепты/flows.
- **Executor**: детерминированное исполнение, параллельно‑безопасные группы, сбор артефактов, компенсации (saga‑pattern), отмены.
- **Critic/Reflector**: проверяет результаты, формирует сжатые резюме в память, генерирует follow‑ups.
- **Scheduler**: планировщик задач/джобов (долгие индексации, бэкапы, периодические сканы проектов).

### 5) Платформа инструментов 2.0 (плагины)
- **Манифест** `tool.json`: name, version, commands[], JSON Schema аргументов, permissions (fs/net/shell/ui), timeouts, side‑effects, required‑caps.
- **Рантайм**: 
  - `WASI (wasmtime)` для безопасных, быстрых плагинов (Rust/Python via PyO3+WASI‑shim в будущем), или
  - `subprocess JSON‑RPC / MCP‑совместимый` протокол для любых языков.
- **Безопасность**: capability‑система (fs roots, net allowlist, shell off by default), песочницы, подпись плагинов, доверенные каналы обновлений.
- **UX‑обязательства**: dry‑run, auto‑diff для fs/git/shell, превью результатов, режим «shadow‑execute» (эмуляция без эффектов) для обучения.
- **Рецепты (skills/flows)**: декларативный YAML/DSL с типами/валидацией, переменные окружения, условия, циклы, шаблоны.

#### 5.1 MCP‑интеграция (Model Context Protocol)
- **Клиент MCP**: адаптер, поддерживающий подключение к MCP‑серверам (WS/JSON‑RPC), авторизацию, discovery инструментов.
- **Импорт инструментов**: маппинг MCP tool → внутренний `ToolSpec` (с JSON Schema аргументов, permissions, side‑effects).
- **Кэш/реестр**: локальное кэширование метаданных MCP‑инструментов, версионирование, подписи/проверка целостности.
- **Вызов**: проксирование исполнения в MCP‑сервер, потоковый вывод, heartbeats/таймауты, отмена.
- **Политики**: фильтрация инструментов MCP policy‑движком (allowlist серверов/инструментов, caps‑проекция), журнал.
- **Надёжность**: fallback (предложение локальной альтернативы) при недоступности MCP.
- **Наблюдаемость**: события `mcp.connected`, `mcp.tool_invoked`, `mcp.error` в EventBus.

#### 5.2 Умная выборка инструментов через реранкер (Tool Context Builder)
- **Кандидаты**: встроенные + плагины (WASI/subprocess) + импортированные от MCP.
- **Фильтры до ранжирования**: политика (capabilities, risk), платформа (OS/GPU), контекст проекта (язык, repo, файлы), доступность сети.
- **Embedding‑поиск**: 
  - Вектор «задачи» = embedding запроса/контекста; 
  - Вектора инструментов = embedding их «эффективных описаний» (см. 5.3).
  - Косинусная близость → top‑M кандидатов.
- **Реранкинг (Qwen3 0.6B)**:
  - Вход: запрос + top‑M описаний инструментов (краткие usage‑guides).
  - Выход: упорядоченный список top‑N с причинами и «условиями срабатывания».
- **Контекст для Planner/LLM**: в подсказку попадает компактный список top‑N инструментов с usage‑подсказками (уменьшаем токены, повышаем точность).
- **Телеметрия без обучения**: учитываем успех/латентность/отказы, пересчитываем приоритеты (поисковый prior), не меняя модель.

#### 5.3 Генерация «эффективного описания» инструмента (Usage Guide)
- **Когда**: при регистрации/импорте инструмента (локальный плагин или MCP) формируется и кэшируется `UsageGuide`.
- **Как**: из `ToolSpec` и примеров, с помощью LLM‑сводки (без тренировки) и правил:
  - `usage_title`, `usage_summary` (1–2 строки);
  - `preconditions` (окружение, права, пути, сеть, GPU);
  - `arguments_brief` (ключи/значения, типы, defaults);
  - `good_for` / `not_for` (типовые задачи);
  - `constraints` (лимиты, размер/время);
  - `examples` (1–3 коротких примера вызова);
  - `platforms` (win/mac/linux), `cost/latency_class`, `side_effects`, `risk_score`, `capabilities`, `tags`.
- **Хранение**: в реестре инструментов (SQLite) + embedding вектор для поиска/реранка.
- **Актуализация**: по телеметрии/ошибкам автодобавляются предостережения в `not_for`/`preconditions`.
- **Использование**: подаётся в реранкер (5.2) и в Planner как минимальный контекст по top‑N инструментам.

### 6) Память уровня «ассистент» (Qwen3 + гибрид)
- **Модели**:
  - Embedding: `models/qwen3emb` (ONNX/gguf, авто CPU/GPU, кэш токенизации/векторов).
  - Reranker: `models/qwen3_reranker` (0.6B) — обязательный rerank top‑K.
- **Слои**:
  - Session (кратковременная, свёртки разговоров, пассажи инструментов).
  - Semantic: HNSW (cosine), чанки кода/доков/медиа с метаданными (project/tags/recency/frequency).
  - Structured: SQLite (todos/links/projects/notes/recipes), миграции.
  - Knowledge‑graph (опционально): связи задач/файлов/понятий (узлы/рёбра с типами и весами).
- **Гибридный поиск**: ANN(HNSW) + keyword (Tantivy/BM25) → merge‑rerank (Qwen3 0.6B) → смешанный скоринг: `rank = α·similarity + β·recency + γ·quality + δ·graph_affinity`.
- **Индексация**: инкрементальная (watcher), батчи эмбеддингов, дедуп (SimHash/MinHash), компрессия/агрегация, прогрев актуальных проектов.
- **Приватность**: локальное шифрование (профиль), удаление по запросу, PII‑сканер.

### 7) LLM‑оркестрация и профили
- **Провайдеры**: локальные (llama.cpp/onnxruntime) и облачные (OpenAI/Anthropic). Единый потоковый API.
- **Оптимизатор**: выбор модели по цене/задержке/качеству, спекулятивное декодирование (cheap→strong), reranker‑gate на длинный контекст, дедуп контекста.
- **Надёжность**: ретраи/таймауты, fallback на локальную модель при сетевых ошибках, токен‑бюджеты.

### 8) Политики/Безопасность (Policy Engine)
- **Policy DSL**: кто/что/где имеет право (fs/net/shell/git), контекстные правила (папки проектов, чувствительные паттерны), уровни доверия плагинов.
- **Оценка риска**: скоринг шага плана (низкий/средний/высокий риск), UX — подтверждения/обоснования.
- **Секреты**: локальный vault (env/токены), secret‑скан в текстах перед сохранением.

### 9) Производительность и устойчивость
- **Actor‑конкурентность**: отдельные пулы (LLM, FS, Index), backpressure, квоты.
- **Индексы**: mmap‑хранилище для HNSW, чанки в SQLite с «горячими» страницами, кэш эмбеддингов по контент‑хэшу.
- **Параллелизм**: батч‑эмбеддинг, многопоточный rerank, ленивые пост‑процессы (обогащение метаданных, KG‑линки).
- **Наблюдаемость**: structured tracing, локальная панель метрик, flamegraph для тяжёлых сценариев.

### 10) TUI/CLI — опыт уровня «вау»
- **Интерактивный план**: древо шагов, параллельные группы, статусы, отмена/повтор, «прыгнуть в лог».
- **Дифф‑центр**: FS/Git диффы с подсветкой, кнопки «принять частично/целиком», режим симуляции.
- **Таймлайн**: «чёрный ящик» — события/инструменты/LLM‑токены/память; быстрый «почему так случилось? ».
- **Навигатор памяти**: результаты RAG, источники/цитаты, граф связей, фильтры, быстрые пилюли контекста.
- **Flow‑студия**: редактор рецептов с валидацией схем, предпросмотром и запуском.

### 11) Контракты (фрагменты)
- **ToolInput/Output** (обязательно `supports_dry_run`, `permissions`):
```json
{
  "command": "file_write",
  "args": {"path": "README.md", "content": "...", "mode": "create"},
  "context": {"cwd": ".", "dry_run": true}
}
```
- **Recipe (YAML/DSL, схематично)**:
```yaml
name: cad_to_gltf
steps:
  - tool: file_search
    args: { path: "~/CAD", pattern: "*.step" }
  - foreach: results
    do:
      - tool: shell_exec
        args: { cmd: "cad2gltf {{item}} -o {{basename(item)}}.gltf" }
      - tool: file_write
        args: { path: "report.md", content: "Converted {{item}}" , mode: append }
```
- **Policy rule (пример)**:
```yaml
rules:
  - match: { tool: shell_exec }
    when: { cwd_in: ["~/Projects"], risk: "medium" }
    allow: ask
  - match: { tool: web_fetch }
    allow_if_domain_in: ["docs.rs", "crates.io", "khronos.org"]
```

### 12) Данные и каталоги
- **Репозиторий**: `models/qwen3emb`, `models/qwen3_reranker` (токенайзеры/конфиги/веса; ONNX/gguf).
- **Пользователь**: `~/.magray/{config,logs,memory,vec_index,artifacts,tools_cache,recipes}`.
- **Проект**: `./.magray/{memory,vec_index,artifacts}` (override глобальных настроек).

### 13) Тестирование/качество
- **Conformance**: для каждого плагина — контрактные тесты (арг‑схемы, permissions, dry‑run, ошибки).
- **RAG‑качество**: golden‑наборы, метрики recall@k, precision после rerank, latency budget.
- **Safety‑симы**: эмуляция опасных планов, проверка policy‑блокировок, реплеи сценариев.
- **Property/Fuzz**: индексы (детерминизм/инварианты), парсеры JSON.

### 14) Безопасные обновления и расширения
- Подписи и хэш‑пины для плагинов/моделей, доверенные каталоги.
- Семантические версии контрактов (tools/recipes), авто‑миграции схем.
- Магазин плагинов (локальный список/индекс) с метаданными, рейтингами (локально кэшируемыми).

### 15) Дорожная карта (сжатая)
- **Фаза A (3–4 недели)**: 
  - MVP платформы инструментов (fs/git/shell с dry‑run/capabilities), EventBus, TUI план/дифф.
  - Память: HNSW + SQLite, Qwen3 Embedding, базовый пайплайн индексации.
- **Фаза B (3–4 недели)**:
  - Rerank Qwen3 0.6B; гибрид ANN+BM25; рецепты (DSL) с валидацией; Scheduler; панель памяти.
- **Фаза C (3–4 недели)**:
  - Мульти‑агентная оркестрация (Planner/Executor/Critic), Policy DSL+UX подтверждений, панель наблюдаемости.
- **Фаза D (3–4 недели)**:
  - Оптимизатор LLM (cost/latency), подписи/обновления плагинов, KG‑связи (минимально полезный), голос/vision как задел.

### 16) Риски и смягчение
- **Без переобучения**: жёсткие подсказки/форматы, reranker, строгие JSON‑контракты.
- **Производительность**: батчи, кэш, mmap, бэкграунд‑обслуживание, прогрев, ограничения контекста.
- **Безопасность**: по умолчанию deny, ask‑to‑confirm, журнал, статический анализ рецептов.

### 17) Папки/крейты (ориентир)
```
crates/
  core/          # domain: модели/контракты/политики
  orchestrator/  # planner/executor/critic/scheduler + EventBus
  memory/        # HNSW + SQLite + пайплайн индексации + rerank
  tools/         # runtime плагинов (WASI/subprocess), registry, встроенные инструменты, MCP‑клиент
  llm/           # провайдеры, менеджер моделей, оптимизатор выбора
  ui/            # TUI/CLI (план/дифф/панель памяти/таймлайн)
  recipes/       # DSL/валидация/исполнитель flows
  policy/        # Policy DSL, оценка риска, интеграция UX
models/
  qwen3emb/
  qwen3_reranker/
configs/
  config.example.toml
```

— Эта архитектура ориентирована на долгую жизнь: платформа (а не монолитный «скрипт»), сильная память (Qwen3 emb + rerank 0.6B), безопасность и прозрачность, сценарная мощь и выдающийся UX (план‑дифф‑выполнение, таймлайн/панели, flows), с нативной поддержкой MCP и умной выборкой инструментов.