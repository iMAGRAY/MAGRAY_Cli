## КРИТЕРИИ ПРИЁМКИ
- Проверен весь проект на соответствие `docs/ARCHITECTURE_PLAN_ADVANCED.md` по ключевым подсистемам.
- Выявлены расхождения (OK/Partial/Missing) с точными ссылками на файлы/участки и рисками.
- Описаны логические/архитектурные ошибки, уязвимости, недостающие элементы, скрытая сложность.
- Даны прицельные рекомендации (fix-план) с приоритетом и оценкой трудозатрат.
- Сохранён отчёт в виде этого файла, без побочных эффектов.

## ПЛАН (краткий)
- Инвентаризация подсистем → картирование на архитектурный план.
- Глубокая проверка безопасности (policy/sandbox/MCP/плагины), памяти (ANN+BM25+rerank), оркестрации, наблюдаемости, UX dry‑run/диффов.
- Выделение критичных несоответствий/ошибок → рекомендации/миграции.
- Мини‑ADR о текущем статусе и ближайших шагах.

## АУДИТ ПРОЕКТА (развёрнуто)

### Соответствие архитектурному плану (по разделам)
- EventBus / Событийная шина — OK
  - Реализация: `crates/common/src/event_bus.rs`, глобальный JSON‑bus: `crates/common/src/events.rs`.
  - Топики совпадают с планом: `intent`, `plan`, `tool.invoked`, `fs.diff`, `memory.upsert`, `memory.search`, `policy.block`, `job.progress`, `llm.tokens`, `error`, `health` (см. `crates/common/src/topics.rs`).
  - Наблюдаемость: метрики инструментов через агрегатор (`start_tool_metrics_aggregator`).

- Policy Engine / Политики — PARTIAL
  - Реализация: `crates/common/src/policy.rs` + обвязка в CLI `crates/cli/src/commands/tools.rs`.
  - Поддержка `Allow/Deny/Ask`, `when_contains_args`, merge default+file+env.
  - Предчек по sandbox и разрешениям: есть (`precheck_permissions`), но срабатывает только если у инструмента задан `spec.permissions`.
  - По умолчанию политика «deny shell_exec», остальное — allow. Это смягчает безопасность.

- Платформа инструментов/плагины — PARTIAL
  - Реестр и типы: `crates/tools/src/lib.rs` (Tool, ToolSpec, ToolRegistry), расширенная система: `tools/registry`, `tools/execution`, `tools/plugins`.
  - Плагины: заявлены WASM + внешние процессы. WASM‑рантайм сейчас имитационный (не wasmtime/WASI), без реальной песочницы/валидатора. Внешние процессы — есть базовая «песочница» окружения, изоляция = User (нет chroot/контейнера/seccomp). Подписи и доверенные каналы — отсутствуют.

- MCP (Model Context Protocol) — PARTIAL
  - Реализован «stdio proxy» (`crates/tools/src/mcp.rs`), JSON-запрос/ответ, таймаут 30с.
  - Нет discovery/аутентификации/стриминга/сердцебиений; нет проекции разрешений/политик на MCP‑инструменты; нет allowlist серверов.

- Память / Индексы / RAG — PARTIAL
  - ANN/HNSW: есть модульные обёртки и координатор поиска (`crates/memory/src/orchestration/search_coordinator.rs`), метрики/лимиты/ретраи/CB, целевые p95: <100ms для поиска.
  - BM25/Tantivy: есть реализация на `tantivy` (`keyword_index/tantivy_index.rs`), но в прод‑координаторе используется in‑memory BM25 (`keyword_index/mod.rs`). Т.е. Tantivy сейчас не задействован.
  - Reranker Qwen3 0.6B: присутствует, ленивая инициализация, безопасный fallback при отключенном ORT.
  - Персистентность: основная «simple engine» пишет JSONL (`magray_memory.jsonl`), SQLite как системный слой — отсутствует; sled используется для отдельных подсистем/кэша (при фичах).

- Оркестрация (Planner/Executor/Critic/Scheduler) — PARTIAL
  - CLI `smart`: простой Planner/Executor, без Critic/Scheduler.
  - Интегрированный оркестратор инструментов (`crates/cli/src/orchestrator/tool_orchestrator.rs`) с enhanced tool system и метриками — есть, но без полного жизненного цикла акторов.

- Наблюдаемость / Логирование — OK/PARTIAL
  - Structured logging, JSON layer, макросы и таймеры (`crates/common/src/structured_logging.rs`). В CLI по умолчанию включён человекочитаемый вывод, JSON — опционально.
  - Health‑checks/статусы/перф.метрики присутствуют.

- Безопасность / Песочница — PARTIAL
  - FS/NET/Shell sandbox конфиг через env+файл (`crates/common/src/sandbox_config.rs`).
  - Инструменты FILE/WEB уважают песочницу (allowlist, roots). `shell_exec` защищён политикой по умолчанию, но при разрешении — ограничений мало (см. ниже).
  - Нет сканера секретов/PII, нет подписей плагинов/моделей.

- LLM‑оптимизатор — OK/PARTIAL
  - Стоимостной оптимизатор/подбор провайдера (`crates/llm/src/cost_optimizer.rs`) есть; токен‑бюджеты/спекулятивное декодирование — отсутствуют.

- TUI/CLI UX (план/дифф/таймлайн) — PARTIAL
  - Есть дифф‑события `fs.diff`, предпросмотр/dry‑run у инструментов, таймлайн‑тесты; полноценная TUI — отсутствует.

- DSL рецептов/flows — MISSING
  - YAML/DSL рецептов с валидацией схем нет (есть лишь YAML‑парсинг для DI‑конфигов памяти).

### Критические проблемы, риски и логические ошибки

1) MCP‑инструменты обходят песочницу/политику разрешений (High)
- Симптом: `mcp.rs` создаёт `ToolSpec` без `permissions`; CLI предчек по песочнице (`precheck_permissions`) срабатывает только при наличии `spec.permissions`. Для MCP — нет.
- Риск: удалённый MCP‑сервер получает произвольные команды/аргументы без ограничений FS/NET/Shell уровня MAGRAY (кроме явных правил Policy по имени инструмента).
- Рекомендация: при регистрации MCP маппить разрешения (минимум net=none/allowlist), требовать явный allowlist серверов/инструментов; по умолчанию — `Ask`.

2) WASM плагины без реального рантайма/изоляции (High)
- Симптом: `plugins/wasm_plugin.rs` — «упрощённый рантайм», без wasmtime/WASI, без песочницы памяти/системных вызовов. «Выполнение» — эмуляция.
- Риск: несоответствие заявленной безопасности, невозможность реального исполнения безопасных wasm‑плагинов.
- Рекомендация: заменить на wasmtime с ресурсными лимитами (fuel, memory), ограниченными хост‑функциями, файловой песочницей; ввести сигнатуры плагинов.

3) Гибридный поиск использует in‑memory BM25, Tantivy не задействован (Medium)
- Симптом: `SearchCoordinator` инициализирует `KeywordIndex::new()` из `keyword_index/mod.rs`, а не `tantivy_index`.
- Риск: слабая релевантность/масштабируемость, несоответствие архитектуре.
- Рекомендация: включить `tantivy` реализацию по флагу/конфигу, обеспечить on‑disk индекс и инкрементальную индексацию.

4) Политика «Allow by default» вне sandbox‑чека (Medium)
- Симптом: `PolicyEngine` по умолчанию `Allow`, если правило не совпало. Для встроенных инструментов FS/WEB есть внутренние проверки, но для внешних/плагинов — зависит от `permissions`.
- Риск: «тихое» разрешение новых инструментов/сценариев без явной политики.
- Рекомендация: сменить дефолт на `Ask` (или `Deny` для категорий риска), добавить глобальные guard‑правила.

5) `shell_exec` небезопасен при явном разрешении (High)
- Симптом: по умолчанию заблокирован политикой; при снятии блока нет FS/NET root‑ограничений, только чистая env и таймаут. Нет deny‑списка/паттернов (вне тестов/валидаторов реестра).
- Риск: опасные команды при ошибочной политике.
- Рекомендация: принудительные ограничения (allow‑список подмножеств команд, chroot/namespace или контейнер), обязательный dry‑run+ask.

6) EventBus: «publish_timeout» неэффективен (Low/Design)
- Симптом: `timeout` оборачивает синхронный `broadcast::Sender::send` внутри async‑блока — таймаут не оказывает эффекта (операция не await'ится).
- Риск: вводит в заблуждение, метрики таймаутов бессмысленны.
- Рекомендация: убрать «таймаут», оставить обработку ошибок `Lagged/No subscribers`.

7) Персистентность памяти — JSONL вместо SQLite (Medium)
- Симптом: `SimpleMemoryEngine` пишет в `magray_memory.jsonl`, без транзакций/индексов.
- Риск: потеря/дубли при сбоях, слабая целостность, нет ACID.
- Рекомендация: ввести SQLite слой (или sled с журналированием) + миграции.

8) Плагины: нет доверенной модели/подписи/политик обновлений (High)
- Симптом: `tools/plugins` не проверяет подписи, не хранит хэши, нет доверенных источников.
- Риск: цепочка поставки.
- Рекомендация: подписи (Ed25519), хэш‑пины, локальный реестр доверенных.

9) Отсутствует сканер секретов/PII при выводе/сохранении (Medium)
- Рекомендация: перед записью в FS/Git и отправкой в сеть — проверка шаблонов (ключи, токены) и редакция.

10) Документация CLI расходится с реализацией (Low)
- Симптом: `docs/API.md` указывает `magray tool`, фактически `magray tools`.
- Рекомендация: выровнять доки/CLI.

11) Дубли систем исполнения инструментов (Medium)
- Симптом: одновременно `execution_pipeline` (legacy) и `execution/pipeline` (v2), пересечения ответственности.
- Риск: технический долг, расхождение поведения.
- Рекомендация: консолидировать в единую реализацию.

12) Недостающие элементы из плана (Medium/roadmap)
- Scheduler, Critic/Reflector, Policy DSL продвинутый, TUI панели, KG, рецепты/flows DSL.

### Рекомендации и план исправлений

Приоритет P0 (безопасность и корректность)
- MCP: ввести allowlist серверов/инструментов, маппинг разрешений, дефолт `Ask`, отключение сети по умолчанию.
- WASM: перейти на wasmtime+WASI; минимальный MVP — загрузка .wasm, sandbox FS, лимиты, явные host‑функции.
- Политика: дефолт `Ask` для неизвестных инструментов; обязательный dry‑run превью для всех операций с побочными эффектами.
- `shell_exec`: оставить Deny по умолчанию; при Allow — жёсткие лимиты (cwd в песочнице, deny‑patterns, no network namespaces/rlimits).

Приоритет P1 (качество поиска/памяти)
- Подключить `tantivy` BM25 по фиче `keyword-search` по умолчанию; on‑disk индекс.
- Перевести память на SQLite (или sled с журналом) + миграции.
- Оценить rerank качество/латентность на golden‑наборах; добавить fallback стратегию (score‑merge) при ошибках модели.

Приоритет P2 (наблюдаемость/UX/арх)
- Исправить EventBus publish «таймаут».
- Включить JSON‑лог по умолчанию в CI/production.
- Консолидировать pipeline исполнения инструментов.
- Обновить документацию CLI.

Грубая оценка трудозатрат
- MCP hardening: 2–4 дня.
- WASM (минимум wasmtime + sandbox): 5–10 дней.
- Tantivy интеграция «как по плану»: 2–3 дня.
- SQLite слой + миграции: 3–5 дней.
- Политики `Ask` + глобальный превью: 1–2 дня.

### Доказательства (файлы/фрагменты)
- EventBus: `crates/common/src/event_bus.rs` (синхронный `send` внутри `timeout`), `crates/common/src/events.rs` (агрегатор метрик), `crates/common/src/topics.rs`.
- Policy: `crates/common/src/policy.rs` (default allow/deny shell_exec), предчек `precheck_permissions`.
- Tools/CLI: `crates/cli/src/commands/tools.rs` (evaluate_tool + preview/ask), MCP регистрация `AddMcp`.
- MCP: `crates/tools/src/mcp.rs` (нет permissions, stdio proxy).
- WASM: `crates/tools/src/plugins/wasm_plugin.rs` (эмуляция рантайма).
- ExternalProcess: `crates/tools/src/plugins/external_process.rs` (изоляция уровня User, без контейнера/секъюрити политик ОС).
- BM25: `crates/memory/src/keyword_index/mod.rs` (in‑memory), `keyword_index/tantivy_index.rs` (не используется в координаторе).
- SearchCoordinator: `crates/memory/src/orchestration/search_coordinator.rs` (таймауты 50–100ms, метрики, lazy rerank init).
- Memory simple engine: `crates/memory/src/api.rs` (JSONL store).
- Shell: `crates/tools/src/shell_ops.rs` (env очистка, таймауты, но нет FS/NET ограничителей при Allow).

## PREVIEW/DRY‑RUN (что будет изменено)
- Этот аудит — read‑only. Никаких изменений в коде (кроме добавления этого файла отчёта).
- Предложенные правки помечены приоритетами P0/P1/P2; реализация требует отдельных PR с диффами и подтверждениями.

## ПРОВЕРКА (как валидировать)
- Безопасность MCP: попытаться выполнить MCP‑инструмент с сетевым вызовом при пустом `MAGRAY_NET_ALLOW` — должно блокироваться (после фикса).
- WASM: добавить тестовый wasm‑плагин (hello world) — должен исполняться в wasmtime с лимитами.
- Гибрид: включить `keyword-search`, проверить, что используется `tantivy` (лог/метрики), сравнить качество/латентность.
- Политики: для `shell_exec` в режиме Allow — убедиться, что ask/dry‑run срабатывают, а опасные команды блокируются.
- EventBus: убрать «таймаут» и убедиться, что поведение публикации/лагов корректно отражается в логах.

## ОТЧЁТ О РЕАЛИЗАЦИИ
- ✅ Completed: этот файл `docs/critical_audit.md` добавлен; аудит покрывает подсистемы и даёт приоритетный план.
- 🔧 #INCOMPLETE: фактические фиксы не применялись (требует отдельных PR). Оценка: см. трудозатраты выше.

## MINI‑ADR
- Решение: провести честный аудит текущей реализации относительно архитектурного плана, зафиксировать разрывы и предложить безопасный план закрытия.
- Критерии: безопасность (default‑deny/ask, sandbox), соответствие ANN+BM25+rerank, плагинная модель (WASM/External/MCP), наблюдаемость.
- Отвергнутые альтернативы: «косметические» правки без изменения модели доверия и рантайма плагинов — не удовлетворяют требованиям безопасности.
- Компромиссы: часть возможностей реализована как MVP (emulated WASM, in‑memory BM25, JSONL store) ради скорости; это требует апгрейда перед продакшеном.

## ДАЛЬШЕ
- Подготовить PR‑серию по P0: MCP hardening, WASM на wasmtime, политика `Ask`/preview по умолчанию для side‑effects.
- Включить `tantivy` по умолчанию и добавить интеграционные метрики качества/латентности.
- Проработать SQLite слой и миграции памяти + бэкапы.
- Обновить документы (`docs/API.md`) в соответствии с CLI.
- Включить JSON‑логирование в production‑профиле и консолидировать pipeline исполнения инструментов.