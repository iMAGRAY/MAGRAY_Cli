# –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–∏—Å—Ç–µ–º—ã - –î–µ—Ç–∞–ª—å–Ω—ã–π –æ–±–∑–æ—Ä

#architecture #system #detailed #workspace

–°–≤—è–∑–∞–Ω–æ: [[MAGRAY CLI - –ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –ø—Ä–æ–µ–∫—Ç–∞]], [[–ì—Ä–∞—Ñ —Å–≤—è–∑–µ–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤]], [[–ü–æ—Ç–æ–∫–∏ –¥–∞–Ω–Ω—ã—Ö –≤ —Å–∏—Å—Ç–µ–º–µ]]

## üèóÔ∏è –û–±—â–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–∏—Å—Ç–µ–º—ã

MAGRAY CLI –ø–æ—Å—Ç—Ä–æ–µ–Ω –∫–∞–∫ –º–æ–¥—É–ª—å–Ω—ã–π Rust workspace —Å 8 crates, —Å–ª–µ–¥—É—é—â–∏–π –ø—Ä–∏–Ω—Ü–∏–ø–∞–º SOLID –∏ clean architecture. –°–∏—Å—Ç–µ–º–∞ —Å–ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∞ –¥–ª—è production use —Å –∞–∫—Ü–µ–Ω—Ç–æ–º –Ω–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å, –Ω–∞–¥—ë–∂–Ω–æ—Å—Ç—å –∏ –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å.

### üéØ –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã

- **Modular Design**: –ö–∞–∂–¥—ã–π crate –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ –æ–¥–∏–Ω –¥–æ–º–µ–Ω
- **Dependency Injection**: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ DI –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—è–º–∏
- **Graceful Degradation**: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π fallback –ø—Ä–∏ —Å–±–æ—è—Ö
- **Production Ready**: Health checks, monitoring, structured logging
- **Type Safety**: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ç–∏–ø–æ–≤ Rust –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –æ—à–∏–±–æ–∫

## üìä Workspace —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ (8 crates)

```mermaid
graph TB
    subgraph "üéØ User Interface Layer"
        CLI[CLI Crate]
        CLI --> |Commands| AGENT[Unified Agent]
        CLI --> |Status| HEALTH[Health Checks]
        CLI --> |UI| PROGRESS[Progress System]
    end
    
    subgraph "üß† Intelligence Layer"  
        LLM[LLM Crate]
        LLM --> |Intent| INTENT[Intent Analyzer]
        LLM --> |Actions| PLANNER[Action Planner]
        LLM --> |Tools| SELECTOR[Tool Selector]
        LLM --> |Params| EXTRACTOR[Parameter Extractor]
    end
    
    subgraph "üóÑÔ∏è Data Layer"
        MEMORY[Memory Crate]
        MEMORY --> |L1| INTERACT[Layer Interact - 24h]
        MEMORY --> |L2| INSIGHTS[Layer Insights - 90d] 
        MEMORY --> |L3| ASSETS[Layer Assets - ‚àû]
        INTERACT --> HNSW[HNSW Vector Index]
        INSIGHTS --> HNSW
        ASSETS --> HNSW
    end
    
    subgraph "üöÄ AI/ML Layer"
        AI[AI Crate]
        AI --> |Models| QWEN[Qwen3 Models]
        AI --> |Models| BGE[BGE-M3 Models]
        AI --> |Compute| GPU[GPU Pipeline]
        AI --> |Fallback| CPU[CPU Service]
    end
    
    subgraph "üîß Execution Layer"
        TOOLS[Tools Crate]
        ROUTER[Router Crate]
        TODO[Todo Crate]
        
        TOOLS --> |File| FILE_OPS[File Operations]
        TOOLS --> |Git| GIT_OPS[Git Operations]
        TOOLS --> |Web| WEB_OPS[Web Operations]
        TOOLS --> |Shell| SHELL_OPS[Shell Operations]
        
        ROUTER --> |Smart| ORCHESTRATION[Task Orchestration]
        TODO --> |DAG| GRAPH[Task Graph]
    end
    
    subgraph "üõ†Ô∏è Foundation Layer"
        COMMON[Common Crate]
        COMMON --> |Logging| STRUCTURED[Structured Logging]
        COMMON --> |Errors| ERROR_HANDLING[Error Handling]
        COMMON --> |Metrics| MONITORING[Monitoring]
    end
    
    CLI --> LLM
    LLM --> MEMORY
    LLM --> ROUTER
    MEMORY --> AI
    ROUTER --> TOOLS
    ROUTER --> TODO
    
    style CLI fill:#e1f5fe
    style MEMORY fill:#f3e5f5
    style AI fill:#fff3e0
    style TOOLS fill:#e8f5e8
    style COMMON fill:#fce4ec
```

## üîÑ –û—Å–Ω–æ–≤–Ω—ã–µ –ø–æ—Ç–æ–∫–∏ –¥–∞–Ω–Ω—ã—Ö

### 1. –ö–æ–º–∞–Ω–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ‚Üí –†–µ–∑—É–ª—å—Ç–∞—Ç

```mermaid
sequenceDiagram
    participant User
    participant CLI
    participant Agent
    participant LLM
    participant Memory
    participant AI
    participant Tools
    
    User->>CLI: magray chat "–í–æ–ø—Ä–æ—Å"
    CLI->>Agent: process_command()
    Agent->>LLM: analyze_intent()
    LLM->>Memory: search_context()
    Memory->>AI: embed_query()
    AI->>Memory: vector_search()
    Memory->>LLM: relevant_context
    LLM->>Tools: execute_if_needed()
    Tools->>Agent: results
    Agent->>CLI: formatted_response
    CLI->>User: –†–µ–∑—É–ª—å—Ç–∞—Ç —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º
```

### 2. –í–µ–∫—Ç–æ—Ä–Ω—ã–π –ø–æ–∏—Å–∫ –≤ –ø–∞–º—è—Ç–∏

```mermaid
graph LR
    A[Query Text] --> B[AI Embedding Service]
    B --> C[Vector 1024D]
    C --> D[HNSW Index Search]
    D --> E{Layer Selection}
    E --> F[Layer Interact]
    E --> G[Layer Insights] 
    E --> H[Layer Assets]
    F --> I[O(log n) Search]
    G --> I
    H --> I
    I --> J[Top-K Results]
    J --> K[Semantic Reranking]
    K --> L[Final Results]
```

## üì¶ –î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ crates

### üéØ CLI Crate (90% –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏)

**–¶–µ–ª—å**: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –∏ entry point

**–ö–ª—é—á–µ–≤—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:**
- `UnifiedAgent` - –≥–ª–∞–≤–Ω—ã–π –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä
- `Health Checks` - –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã
- `Progress System` - –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
- `Commands` - –º–æ–¥—É–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –∫–æ–º–∞–Ω–¥

**API Entry Points:**
```rust
magray chat "question"      // –ß–∞—Ç —Å LLM
magray smart "task"         // –£–º–Ω–æ–µ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
magray tool "action"        // –ü—Ä—è–º–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
magray status               // –°—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã
magray gpu status           // GPU –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
magray memory stats         // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–∞–º—è—Ç–∏
```

### üóÑÔ∏è Memory Crate (85% –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏)

**–¶–µ–ª—å**: –¢—Ä—ë—Ö—Å–ª–æ–π–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –ø–∞–º—è—Ç–∏ —Å –≤–µ–∫—Ç–æ—Ä–Ω—ã–º –ø–æ–∏—Å–∫–æ–º

**–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–ª–æ—ë–≤:**

| –°–ª–æ–π | TTL | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ | –ò–Ω–¥–µ–∫—Å |
|------|-----|------------|---------|
| **Interact** | 24h | Session context, hot data | HNSW |
| **Insights** | 90d | Extracted knowledge | HNSW |
| **Assets** | ‚àû | Code, docs, static data | HNSW |

**–ö–ª—é—á–µ–≤—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:**
- `VectorStore` - –æ—Å–Ω–æ–≤–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –≤–µ–∫—Ç–æ—Ä–æ–≤
- `VectorIndexHnswRs` - HNSW –∏–Ω–¥–µ–∫—Å –¥–ª—è O(log n) –ø–æ–∏—Å–∫–∞
- `MLPromotionEngine` - ML-based promotion –º–µ–∂–¥—É —Å–ª–æ—è–º–∏
- `BatchOperationManager` - –ø–∞–∫–µ—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö
- `StreamingMemoryAPI` - real-time –ø–æ—Ç–æ–∫–æ–≤–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞

**Performance Metrics:**
- –ü–æ–∏—Å–∫: O(log n) - –º–µ–Ω–µ–µ 5–º—Å –Ω–∞ –∑–∞–ø—Ä–æ—Å
- –ò–Ω–¥–µ–∫—Å–∞—Ü–∏—è: –ü–∞–∫–µ—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–æ 1000 –≤–µ–∫—Ç–æ—Ä–æ–≤/—Å–µ–∫
- Promotion: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ –ø–æ ML –∫—Ä–∏—Ç–µ—Ä–∏—è–º

### üöÄ AI Crate (95% –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏)

**–¶–µ–ª—å**: AI/ML —Å–µ—Ä–≤–∏—Å—ã –¥–ª—è embeddings –∏ reranking

**–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ –º–æ–¥–µ–ª–∏:**

| –ú–æ–¥–µ–ª—å | –¢–∏–ø | –†–∞–∑–º–µ—Ä–Ω–æ—Å—Ç—å | –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç | –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ |
|--------|-----|-------------|-----------|-------------|
| **Qwen3** | Embedding | 1024D | Primary | –†—É—Å—Å–∫–∏–π —è–∑—ã–∫, –±—ã—Å—Ç—Ä–∞—è |
| **BGE-M3** | Embedding | 1024D | Legacy | –ú—É–ª—å—Ç–∏—è–∑—ã—á–Ω–∞—è |
| **Qwen3 Reranker** | Reranker | - | Primary | –°–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ—Ä–∞–Ω–∂–∏—Ä–æ–≤–∞–Ω–∏–µ |
| **BGE Reranker v2-m3** | Reranker | - | Legacy | –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π |

**GPU Infrastructure:**
- `GpuFallbackManager` - –Ω–∞–¥—ë–∂–Ω—ã–π fallback CPU ‚Üî GPU
- `CircuitBreaker` - –∑–∞—â–∏—Ç–∞ –æ—Ç –∫–∞—Å–∫–∞–¥–Ω—ã—Ö —Å–±–æ–µ–≤ GPU
- `GpuPipelineManager` - –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞ GPU
- `MemoryPool` - –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è GPU memory usage

**Performance:**
- GPU: 10x —É—Å–∫–æ—Ä–µ–Ω–∏–µ –¥–ª—è –±–æ–ª—å—à–∏—Ö batch
- CPU: Graceful fallback —Å –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π
- Memory: –ê–¥–∞–ø—Ç–∏–≤–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ GPU –ø–∞–º—è—Ç—å—é

### üß† LLM Crate (80% –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏)

**–¶–µ–ª—å**: –ê–≥–µ–Ω—Ç–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —è–∑—ã–∫–æ–≤—ã–º–∏ –º–æ–¥–µ–ª—è–º–∏

**–ê–≥–µ–Ω—Ç–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞:**
- `IntentAnalyzer` - –∞–Ω–∞–ª–∏–∑ –Ω–∞–º–µ—Ä–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `ActionPlanner` - –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –º–Ω–æ–≥–æ—à–∞–≥–æ–≤—ã—Ö –∑–∞–¥–∞—á
- `ToolSelector` - –≤—ã–±–æ—Ä –ø–æ–¥—Ö–æ–¥—è—â–∏—Ö –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
- `ParameterExtractor` - –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –∏–∑ NL

**–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ –ø—Ä–æ–≤–∞–π–¥–µ—Ä—ã:**
- OpenAI (GPT-4, GPT-3.5)
- Anthropic (Claude)
- Local models (—á–µ—Ä–µ–∑ ONNX/llama.cpp)

### üîÄ Router Crate (70% –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏)

**–¶–µ–ª—å**: –ò–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω–∞—è –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è –∏ –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ü–∏—è –∑–∞–¥–∞—á

**–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:**
- `SmartRouter` - –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–∏–ø–∞ –∑–∞–¥–∞—á–∏ –∏ –º–∞—Ä—à—Ä—É—Ç–∞
- `TaskOrchestrator` - –∫–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Å–ª–æ–∂–Ω—ã—Ö –∑–∞–¥–∞—á
- `IntentClassifier` - –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è –Ω–∞–º–µ—Ä–µ–Ω–∏–π

**Routing Logic:**
```
User Input ‚Üí Intent Analysis ‚Üí Route Selection ‚Üí Task Execution
           ‚Üì                 ‚Üì                ‚Üì
         Chat/Question    Tool/Action     Smart/Planning
```

### üõ†Ô∏è Tools Crate (90% –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏)

**–¶–µ–ª—å**: –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π

**–î–æ—Å—Ç—É–ø–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã:**
- `FileOps` - —á—Ç–µ–Ω–∏–µ, –∑–∞–ø–∏—Å—å, –Ω–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ —Ñ–∞–π–ª–∞–º
- `GitOps` - –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å git —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è–º–∏
- `WebOps` - –≤–µ–±-–ø–æ–∏—Å–∫ –∏ –∑–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
- `ShellOps` - –±–µ–∑–æ–ø–∞—Å–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ shell –∫–æ–º–∞–Ω–¥

**–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:**
- –ü–µ—Å–æ—á–Ω–∏—Ü–∞ –¥–ª—è shell –∫–æ–º–∞–Ω–¥
- –í–∞–ª–∏–¥–∞—Ü–∏—è –ø—É—Ç–µ–π —Ñ–∞–π–ª–æ–≤
- Rate limiting –¥–ª—è web –æ–ø–µ—Ä–∞—Ü–∏–π
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π

### üìã Todo Crate (75% –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏)

**–¶–µ–ª—å**: –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á–∞–º–∏ –∏ dependency graph

**–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:**
- `TaskGraph` - DAG —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–ª—è –∑–∞–¥–∞—á
- `TaskStore` - SQLite —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –∑–∞–¥–∞—á
- `DependencyResolver` - —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

### üõ†Ô∏è Common Crate (100% –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏)

**–¶–µ–ª—å**: –û–±—â–∏–µ —É—Ç–∏–ª–∏—Ç—ã –∏ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞

**–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:**
- `StructuredLogging` - JSON –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è production
- `ErrorHandling` - typed error system
- `Monitoring` - –º–µ—Ç—Ä–∏–∫–∏ –∏ health checks

## üîó –ú–µ–∂–∫–æ–º–ø–æ–Ω–µ–Ω—Ç–Ω—ã–µ —Å–≤—è–∑–∏

### –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –º–µ–∂–¥—É crates

```mermaid
graph TD
    COMMON[common] 
    AI[ai] --> COMMON
    MEMORY[memory] --> AI
    MEMORY --> COMMON
    LLM[llm] --> MEMORY
    LLM --> COMMON
    TOOLS[tools] --> COMMON
    TODO[todo] --> COMMON
    ROUTER[router] --> LLM
    ROUTER --> TOOLS
    ROUTER --> TODO
    ROUTER --> COMMON
    CLI[cli] --> LLM
    CLI --> ROUTER
    CLI --> MEMORY
    CLI --> AI
    CLI --> COMMON
```

### Data Flow Patterns

1. **Request-Response**: –°–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥
2. **Event-Driven**: –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–∞–º—è—Ç–∏
3. **Stream Processing**: Real-time –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö
4. **Batch Processing**: –ü–∞–∫–µ—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –±–æ–ª—å—à–∏—Ö –æ–±—ä—ë–º–æ–≤

## üèóÔ∏è Dependency Injection Architecture

### DI Container Structure

```mermaid
classDiagram
    class DIContainer {
        +register_service()
        +resolve_service()
        +health_check()
    }
    
    class MemoryService {
        +vector_store: VectorStore
        +embedding_service: EmbeddingService
        +promotion_engine: PromotionEngine
    }
    
    class EmbeddingService {
        +gpu_service: GpuService
        +cpu_service: CpuService
        +fallback_manager: FallbackManager
    }
    
    DIContainer --> MemoryService
    DIContainer --> EmbeddingService
    MemoryService --> EmbeddingService
```

### Service Lifecycle

1. **Initialization**: Lazy loading –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
2. **Configuration**: Environment-based –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
3. **Health Monitoring**: Continuous health checks
4. **Graceful Shutdown**: Coordinated cleanup

## üìä Production Architecture Patterns

### Circuit Breaker Pattern

```rust
// –ü—Ä–∏–º–µ—Ä circuit breaker –¥–ª—è GPU
impl CircuitBreaker {
    fn is_service_available(&mut self) -> bool {
        match self.state {
            CircuitState::Closed => true,
            CircuitState::Open => self.check_recovery_time(),
            CircuitState::HalfOpen => true,
        }
    }
}
```

### Observer Pattern –¥–ª—è Events

```rust
// Event —Å–∏—Å—Ç–µ–º–∞ –¥–ª—è –º–µ–∂–∫–æ–º–ø–æ–Ω–µ–Ω—Ç–Ω–æ–π –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏
pub enum SystemEvent {
    MemoryPromoted { from: Layer, to: Layer },
    GpuFallback { reason: String },
    HealthCheck { component: String, status: Health },
}
```

### Strategy Pattern –¥–ª—è Providers

```rust
// –°—Ç—Ä–∞—Ç–µ–≥–∏—è –¥–ª—è —Ä–∞–∑–Ω—ã—Ö LLM –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤
pub trait LlmProvider {
    async fn generate(&self, prompt: &str) -> Result<String>;
    fn model_info(&self) -> ModelInfo;
}
```

## ‚ö° Performance Optimizations

### 1. Vector Search Optimization

- **HNSW Algorithm**: O(log n) search complexity
- **Batch Processing**: Vectorized operations
- **Memory Pool**: Reduced allocations
- **Parallel Search**: Multi-threaded queries

### 2. GPU Memory Management

- **Memory Pool**: Pre-allocated GPU buffers
- **Batch Optimization**: Optimal batch sizes
- **Pipeline Processing**: Overlapped CPU/GPU work
- **Fallback Strategy**: Seamless CPU fallback

### 3. Caching Strategy

- **LRU Cache**: Embedding cache with eviction
- **Result Cache**: Query result caching
- **Model Cache**: Loaded model reuse
- **Index Cache**: HNSW index persistence

## üõ°Ô∏è Reliability & Resilience

### Error Handling Strategy

1. **Typed Errors**: Structured error types
2. **Error Propagation**: Consistent error handling
3. **Graceful Degradation**: Fallback mechanisms
4. **Recovery Procedures**: Automatic recovery

### Health Monitoring

- **Component Health**: Individual service health
- **System Health**: Overall system status
- **Performance Metrics**: Real-time metrics
- **Alerting**: Production alerts

## üîÆ Future Architecture Evolution

### Planned Enhancements

1. **Distributed Architecture**: Multi-node scaling
2. **Plugin System**: Dynamic component loading
3. **Advanced ML**: More sophisticated promotion algorithms
4. **Cloud Integration**: Cloud provider support

### Scalability Roadmap

- **Horizontal Scaling**: Multiple instance support
- **Database Sharding**: Distributed vector storage
- **Load Balancing**: Request distribution
- **Caching Layer**: Distributed caching

---

## ‚ùå –ß–µ—Å—Ç–Ω–∞—è –æ—Ü–µ–Ω–∫–∞ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã

### –ß—Ç–æ –ù–ï —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ:
- –ü–æ–ª–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤—Å–µ—Ö DI –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
- Distributed caching system
- Advanced error recovery –≤ –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞—Ö
- Complete observability infrastructure

### ‚ö†Ô∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è:
- –ú–æ–Ω–æ–ª–∏—Ç–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ (single binary)
- –ù–µ—Ç hot-reload –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
- Limited horizontal scaling
- Memory-bound –¥–ª—è –±–æ–ª—å—à–∏—Ö datasets

### üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –¥–æ–ª–≥:
- –ù–µ–∫–æ—Ç–æ—Ä—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç direct coupling
- Mock implementations –≤ —Å–ª–æ–∂–Ω—ã—Ö –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è—Ö
- Simplified error handling –≤ –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö path
- Configuration management —Ä–∞–∑–±—Ä–æ—Å–∞–Ω –ø–æ crates

### üìä –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–∞—è –∑—Ä–µ–ª–æ—Å—Ç—å: 82%
(Solid foundation —Å production-ready patterns, –Ω–æ —Ç—Ä–µ–±—É–µ—Ç –¥–æ—Ä–∞–±–æ—Ç–∫–∏ –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–π –∏ advanced features)

---

*–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: 05.08.2025*  
*–ê–Ω–∞–ª–∏–∑ –≤—ã–ø–æ–ª–Ω–µ–Ω –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –∏–∑—É—á–µ–Ω–∏—è –∫–æ–¥–æ–≤–æ–π –±–∞–∑—ã*