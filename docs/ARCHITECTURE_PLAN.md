# Локально‑первый AI‑ассистент: план архитектуры (революционно, но реалистично)

## 1) Видение и принципы
- **Локально‑первый**: все вычисления и инструменты выполняются на ПК пользователя. Сеть — только для LLM API/моделей по выбору пользователя.
- **Расширяемость как платформа**: никакой «захардкоженной магии». Любой инструмент — плагин с декларацией прав, аргументов и контрактов.
- **Эффективность и UX**: быстрые ответы (стриминг), предсказуемые действия (dry‑run/дифф), понятные планы.
- **Безопасность по умолчанию**: capability‑модель, песочница, allow‑lists, подтверждения опасных изменений.
- **Память как мозг**: многоуровневая память с семантическим поиском, Qwen3 Embedding и Qwen3 Reranker 0.6B.
- **Реалистичность**: без переобучения моделей. Только инженерные улучшения, кэширование, индексация, схемы подсказок.

## 2) Цели и ограничения
- **Цели**: помочь пользователю делать всё на ПК: от «напиши бабушке» до «спроектируй 3D/инженерный проект». Поддержка проектов, кода, графики, CAD/CAE цепочек.
- **Ограничения**: отсутствие переобучения; оффлайн-режим; кроссплатформенность; ограниченные ресурсы CPU/GPU; приватность.

## 3) Высокоуровневая архитектура
- **Domains/Слои**:
  1. Domain (ядро): сущности, бизнес-правила, интерфейсы (без зависимостей на инфраструктуру).
  2. Application: use‑cases, планирование/исполнение, оркестрация циклов Plan→Act→Observe→Reflect.
  3. Adapters: провайдеры LLM, плагины инструментов, память (индексы/хранилища), OS‑интеграции.
  4. Infrastructure: конфиг, профили сборки, TUI/CLI, логирование/трейсинг, изоляция, упаковка.

- **Поток (упрощённо)**:
  1) Ввод (CLI/TUI) → 2) Анализ намерения (LLM + эвристики) → 3) План действий (ActionPlan) →
  4) Маршрутизация инструментов (capabilities/политики) → 5) Исполнение (параллель/пайплайны) →
  6) Наблюдение/рефлексия (критик/сводка) → 7) Обновление памяти (вектор + структура) → 8) Ответ/артефакты.

## 4) Модули и контракты

### 4.1 CLI/TUI и сервисный демон
- Режимы: `chat`, `tool`, `smart`, `tasks`, `memory`, `models`, `tools`, `status`.
- Поддержка TUI: статус системы, лист задач, индексы/память, логи.
- Демон (опционально): долгоживущие фоновые задачи (индексация, бэкапы, планировщик).

### 4.2 Оркестрация (агентные циклы)
- Компоненты: `IntentAnalyzer`, `Planner`, `ToolRouter`, `Executor`, `Critic/Reflector`, `Scheduler`.
- Контракт Planner: вход — Intent/Context/MemoryHits; выход — `ActionPlan { steps: [PlannedAction] }` с объяснениями.
- Контракт Executor: детерминированный порядок, параллельные группы шагов, сбор артефактов, откаты/повторы.
- Политики: Circuit Breakers, бюджет токенов/времени, лимиты изменяющих действий, ask‑to‑confirm для опасных шагов.

### 4.3 Платформа инструментов (plugins)
- Формат описания (каждый инструмент): `tool.json`
  - `name`, `version`, `commands[]`, `args` (JSON Schema), `permissions` (fs/net/shell/ui), `timeouts`, `side_effects`.
- Исполнение:
  - Sandbox: WASI (wasmtime) и/или subprocess JSON‑RPC/MCP‑совместимый протокол.
  - Стриминг вывода, heartbeat, cancellation.
  - `dry_run()` и дифф‑превью (для fs/git/shell): обязательны.
- Реестр: загрузка встроенных и внешних плагинов, версионирование, совместимость, ленты обновлений.

Базовые встроенные инструменты:
- FS: `file_read`, `file_write` (с диффом), `dir_list`, `file_search` (ripgrep/ucsearch).
- Git: `git_status`, `git_diff`, `git_commit`, `git_apply` (с безопасными фильтрами пути).
- Shell: `shell_exec` (по умолчанию disabled; включается explicit capability).
- Web: `web_fetch`, `web_search` (по умолчанию net‑deny; allowlist доменов).
- OS: уведомления, календарь/почта/мессенджеры — как внешние плагины.

### 4.4 Система памяти (Qwen3 Embedding + Qwen3 Reranker 0.6B)
- Модели:
  - Embedding: `models/qwen3emb` (локально, ONNX/gguf; авто‑выбор CPU/GPU; кэширование токенизации/векторов).
  - Reranker: `models/qwen3_reranker` (0.6B), вызывается на top‑K от векторного поиска.
- Слои памяти:
  1) Session Buffer: последние сообщения/операции, компактные свёртки.
  2) Semantic Store: HNSW‑индекс (cosine), чанки файлов/доков/кода, метаданные (recency, frequency, tags, namespace).
  3) Structured Store: SQLite (todos, knowledge, projects, links), транзакции, миграции.
  4) Knowledge Graph (опционально): отношения между задачами/файлами/понятиями.
- Индексация:
  - Инкрементальная: file watcher, батчи эмбеддингов, фоновые задачи простоя.
  - Политики чанкинга: код/markdown/pdf/схемы, агрегация по смыслу, дедупликация.
- Поисковый пайплайн:
  1) ANN (HNSW) → 2) Фильтры (namespace, тип, дата) → 3) Rerank (Qwen3 0.6B) → 4) Смешанный скоринг (similarity × recency × quality) → 5) Контекст LLM.
- Обслуживание: бэкап/restore, сжатие/чистка, защита персональных данных (локальное шифрование по профилю).

### 4.5 LLM слой
- Единый потоковый API: `chat_stream(request)`; поддержка локальных (llama.cpp/onnxruntime) и облачных (OpenAI/Anthropic) провайдеров.
- Функции/инструменты: JSON‑вызовы через ToolRouter (без привязки к конкретной API‑модели).
- Политики: оффлайн‑режим, лимиты токенов/стоимости, ретраи, деградация (локальная модель при недоступности сети).

### 4.6 Конфиг и профили
- `~/.magray/config.toml` + project‑override `.magray/config.toml`.
- Профили: `minimal` (оффлайн без тяжёлых моделей), `cpu`, `gpu` (CUDA/DirectML/OpenVINO).
- Параметры: каталоги памяти/индексов, модельные профили, политики инструментов, allowlists, горячие каталоги проектов.

### 4.7 Безопасность
- Capability‑модель: fs (roots, rw flags), net (domain allowlist), shell (off by default), git (safe), tools (trusted/untrusted).
- UX‑защита: dry‑run, дифф, двухэтапные подтверждения, журнал действий.
- Приватность: локальный storage, опциональное шифрование, отсутствие фоновой отправки данных.

### 4.8 Производительность и надёжность
- Параллельные пайплайны (Rayon/Tokio), батчи эмбеддингов, кэш LRU векторов.
- Прогрев индекса и преселекция контекста по эвристикам.
- Circuit Breakers для инструментов и LLM.
- Наблюдаемость: tracing (JSON), EventBus, локальная панель статусов.

## 5) Данные и контракты (схематично)

### 5.1 ActionPlan (упрощённо)
```json
{
  "reasoning": "Объяснение стратегии",
  "confidence": 0.86,
  "steps": [
    {
      "tool": "file_search",
      "description": "Найти CAD-файлы проекта",
      "args": {"path": "~/Projects/CAD", "pattern": "*.step"},
      "expected_output": "Перечень файлов"
    },
    {
      "tool": "shell_exec",
      "description": "Запустить конвертацию в glTF",
      "args": {"cmd": "cad2gltf input.step -o output.gltf"},
      "expected_output": "GLTF файл"
    }
  ]
}
```

### 5.2 ToolSpec (фрагмент)
```json
{
  "name": "file_write",
  "version": "1.0.0",
  "permissions": {"fs": {"roots": ["."], "write": true}},
  "commands": [
    {
      "name": "write",
      "args_schema": {
        "type": "object",
        "required": ["path", "content"],
        "properties": {
          "path": {"type": "string"},
          "content": {"type": "string"},
          "mode": {"type": "string", "enum": ["create", "append"], "default": "create"}
        }
      },
      "supports_dry_run": true
    }
  ]
}
```

### 5.3 MemoryRecord (логическая схема)
- id (UUID), layer (Interact/Insights/Assets), ts, text, embedding[], tags[], project/session, recency/frequency, source (file/path), metadata (language, chunk_idx, etc.).

## 6) Пайплайн памяти (детали)
- **Индексация**: watcher → чанкинг → Qwen3 Embedding → upsert в HNSW + запись метаданных в SQLite.
- **Поиск**: запрос → embedding → ANN top‑K → фильтры → Qwen3 0.6B rerank → смешанный скоринг → контекст для LLM.
- **Оптимизации**: кэш эмбеддингов (по хэшу содержимого файла/чанка), периодическая переоценка recency/frequency, агрегация ответов, эвристики длины контекста.

## 7) Тестирование и качество
- Юнит‑тесты: детерминированные заглушки LLM, тесты инструментов (fs/git/shell) в песочнице, property‑based для ANN.
- Интеграции: золотые сценарии (flows), mock‑провайдеры LLM, нагрузочные тесты индекса/памяти.
- Политики: «опасные» инструменты — только в отдельных тестах с флагами.

## 8) Пакетирование и кроссплатформенность
- Статические сборки (по возможности), профили CPU/GPU, менеджер моделей.
- Каталоги:
  - Репозиторий: `models/qwen3emb`, `models/qwen3_reranker` — артефакты модели (ONNX/gguf, токенайзеры, конфиги).
  - Данные пользователя: `~/.magray/{config,logs,memory,vec_index,artifacts,tools_cache}`.

## 9) Дорожная карта (90 дней)
- **Недели 1–3**: MVP
  - CLI/TUI базовые режимы; встроенные инструменты fs/git; единый LLM API; загрузчик Qwen3 emb+rerank; минимальная память (индексация/поиск).
- **Недели 4–6**: Память и инструменты
  - Хранилище SQLite + HNSW; инкрементальная индексация; rerank; capability‑модель; dry‑run/дифф; EventBus.
- **Недели 7–9**: Оркестрация и сценарии
  - Planner/Executor/Critic; YAML‑flows; параллельные действия; Circuit Breakers; TUI статус‑панель.
- **Недели 10–12**: UX/надёжность
  - Настройки/профили; бэкапы памяти; авто‑обслуживание индекса; оптимизации производительности; документация SDK плагинов.

## 10) Риски и снижения
- Модельные ограничения (без переобучения) → усилить rerank, аккуратные подсказки, строгие JSON‑контракты.
- Производительность индекса → батчи, кэш, прогрев, ограничение объёма контекста.
- Безопасность инструментов → строгие capabilities, песочница, подтверждения, журнал.

## 11) Предлагаемая структура репозитория (ориентир)
```
crates/
  core/          # domain модели/интерфейсы
  orchestrator/  # planner/executor/critic/scheduler
  tools/         # runtime плагинов + встроенные инструменты
  memory/        # HNSW + SQLite + оркестратор памяти
  llm/           # провайдеры, менеджер моделей, qwen3 emb/rerank инвокеры
  ui/            # TUI/CLI компоненты
  plugins/       # SDK для внешних плагинов (WASI/subprocess)
models/
  qwen3emb/
  qwen3_reranker/
configs/
  config.example.toml
```

## 12) Почему это «революционно» и при этом реалистично
- Путь от «умного CLI» к полнофункциональному локальному ассистенту — через платформу плагинов и сильную память.
- Qwen3 Embedding + Qwen3 Reranker 0.6B дают лучшие не‑обучающие улучшения качества поиска/контекста.
- Безопасность по умолчанию, dry‑run и дифф — доверие и контроль пользователя.
- Производительность достигается инженерно: пайплайны, кэш, батчи, HNSW, rerank — без переобучения.