name: ğŸš€ Multi-Feature Build Matrix

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      release_mode:
        description: 'Build release binaries'
        required: false
        default: false
        type: boolean

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  # Matrix strategy Ğ´Ğ»Ñ Ñ‚ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ²ÑĞµÑ… feature combinations
  feature-matrix:
    name: ${{ matrix.name }}
    runs-on: ${{ matrix.os }}
    
    strategy:
      fail-fast: false
      matrix:
        include:
          # CPU-only builds (Ğ¿Ñ€Ğ¾Ğ¸Ğ·Ğ²Ğ¾Ğ´ÑÑ‚Ğ²Ğ¾)
          - name: "CPU-only Ubuntu"
            os: ubuntu-latest
            features: "cpu"
            target: "x86_64-unknown-linux-gnu"
            artifact: "magray-cpu-linux"
            
          - name: "CPU-only Windows"
            os: windows-latest
            features: "cpu"
            target: "x86_64-pc-windows-msvc"
            artifact: "magray-cpu-windows"
            
          - name: "CPU-only macOS"
            os: macos-latest
            features: "cpu"
            target: "x86_64-apple-darwin"
            artifact: "magray-cpu-macos"
            
          # Minimal builds (ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€Ñ‹/edge)
          - name: "Minimal Ubuntu"
            os: ubuntu-latest
            features: "minimal"
            target: "x86_64-unknown-linux-gnu"
            artifact: "magray-minimal-linux"
            
          - name: "Minimal MUSL (Alpine)"
            os: ubuntu-latest
            features: "minimal"
            target: "x86_64-unknown-linux-musl"
            artifact: "magray-minimal-alpine"
            
          # GPU builds (Ñ€Ğ°Ğ±Ğ¾Ñ‡Ğ¸Ğµ ÑÑ‚Ğ°Ğ½Ñ†Ğ¸Ğ¸)
          - name: "GPU Ubuntu"
            os: ubuntu-latest
            features: "gpu"
            target: "x86_64-unknown-linux-gnu"
            artifact: "magray-gpu-linux"
            
          - name: "GPU Windows"
            os: windows-latest
            features: "gpu"  
            target: "x86_64-pc-windows-msvc"
            artifact: "magray-gpu-windows"

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ¦€ Setup Rust toolchain
      uses: dtolnay/rust-toolchain@stable
      with:
        targets: ${{ matrix.target }}
        components: clippy, rustfmt

    - name: ğŸ“¦ Cache dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-cargo-${{ matrix.features }}-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-${{ matrix.features }}-
          ${{ runner.os }}-cargo-

    - name: ğŸ”§ Install MUSL tools (Linux)
      if: matrix.target == 'x86_64-unknown-linux-musl'
      run: |
        sudo apt-get update
        sudo apt-get install -y musl-tools

    # ĞÑ‚Ğ´ĞµĞ»ÑŒĞ½Ğ°Ñ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° ONNX Runtime Ğ´Ğ»Ñ Ñ€Ğ°Ğ·Ğ½Ñ‹Ñ… OS
    - name: ğŸ¤– Setup ONNX Runtime (Ubuntu)
      if: runner.os == 'Linux'
      run: |
        wget https://github.com/microsoft/onnxruntime/releases/download/v1.22.0/onnxruntime-linux-x64-1.22.0.tgz
        tar -xzf onnxruntime-linux-x64-1.22.0.tgz
        mkdir -p scripts/onnxruntime
        cp -r onnxruntime-linux-x64-1.22.0/* scripts/onnxruntime/
        echo "ORT_DYLIB_PATH=$PWD/scripts/onnxruntime/lib/libonnxruntime.so" >> $GITHUB_ENV

    - name: ğŸ¤– Setup ONNX Runtime (Windows)
      if: runner.os == 'Windows'
      run: |
        curl -L -o onnxruntime-win-x64-1.22.0.zip https://github.com/microsoft/onnxruntime/releases/download/v1.22.0/onnxruntime-win-x64-1.22.0.zip
        Expand-Archive onnxruntime-win-x64-1.22.0.zip
        mkdir scripts/onnxruntime -Force
        Copy-Item -Recurse onnxruntime-win-x64-1.22.0/onnxruntime-win-x64-1.22.0/* scripts/onnxruntime/
        echo "ORT_DYLIB_PATH=$PWD/scripts/onnxruntime/lib/onnxruntime.dll" >> $env:GITHUB_ENV

    - name: ğŸ¤– Setup ONNX Runtime (macOS)
      if: runner.os == 'macOS'
      run: |
        wget https://github.com/microsoft/onnxruntime/releases/download/v1.22.0/onnxruntime-osx-x86_64-1.22.0.tgz
        tar -xzf onnxruntime-osx-x86_64-1.22.0.tgz
        mkdir -p scripts/onnxruntime
        cp -r onnxruntime-osx-x86_64-1.22.0/* scripts/onnxruntime/
        echo "ORT_DYLIB_PATH=$PWD/scripts/onnxruntime/lib/libonnxruntime.dylib" >> $GITHUB_ENV

    # Code quality checks
    - name: ğŸ§¹ Format check
      run: cargo fmt --all -- --check

    - name: ğŸ“‹ Clippy check
      run: cargo clippy --features ${{ matrix.features }} --target ${{ matrix.target }} -- -D warnings

    # Tests
    - name: ğŸ§ª Run tests
      run: cargo test --features ${{ matrix.features }} --target ${{ matrix.target }} --workspace

    # Build
    - name: ğŸ”¨ Build binary
      run: |
        if [ "${{ github.event.inputs.release_mode }}" = "true" ]; then
          cargo build --release --features ${{ matrix.features }} --target ${{ matrix.target }}
        else
          cargo build --features ${{ matrix.features }} --target ${{ matrix.target }}
        fi
      shell: bash

    # Binary analysis
    - name: ğŸ“Š Analyze binary
      run: |
        if [ "${{ github.event.inputs.release_mode }}" = "true" ]; then
          BINARY_PATH="target/${{ matrix.target }}/release"
        else
          BINARY_PATH="target/${{ matrix.target }}/debug"  
        fi
        
        if [ "${{ runner.os }}" = "Windows" ]; then
          BINARY="$BINARY_PATH/magray.exe"
        else
          BINARY="$BINARY_PATH/magray"
        fi
        
        echo "## ğŸ“Š Binary Analysis for ${{ matrix.name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Features:** ${{ matrix.features }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Target:** ${{ matrix.target }}" >> $GITHUB_STEP_SUMMARY
        
        if [ -f "$BINARY" ]; then
          SIZE=$(du -h "$BINARY" | cut -f1)
          echo "- **Size:** $SIZE" >> $GITHUB_STEP_SUMMARY
          echo "- **Status:** âœ… Built successfully" >> $GITHUB_STEP_SUMMARY
        else
          echo "- **Status:** âŒ Build failed" >> $GITHUB_STEP_SUMMARY
        fi
      shell: bash

    # Upload artifacts Ğ´Ğ»Ñ release builds
    - name: ğŸ“¤ Upload binary artifact
      if: github.event.inputs.release_mode == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.artifact }}
        path: |
          target/${{ matrix.target }}/release/magray*
        retention-days: 30

  # Ğ¡Ñ€Ğ°Ğ²Ğ½Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğ¹ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ· Ğ²ÑĞµÑ… ÑĞ±Ğ¾Ñ€Ğ¾Ğº
  analysis:
    name: ğŸ“ˆ Build Analysis
    runs-on: ubuntu-latest
    needs: feature-matrix
    if: always()
    
    steps:
    - name: ğŸ“Š Generate comparison report
      run: |
        echo "# ğŸš€ MAGRAY Build Matrix Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## Feature Comparison" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Feature | Ubuntu | Windows | macOS | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|---------|---------|----------|-------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| CPU     | âœ…      | âœ…       | âœ…    | Stable |" >> $GITHUB_STEP_SUMMARY
        echo "| GPU     | âš ï¸      | âš ï¸       | âŒ    | Requires CUDA |" >> $GITHUB_STEP_SUMMARY
        echo "| Minimal | âœ…      | âœ…       | âœ…    | Container-ready |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## Recommendations" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- ğŸ¯ **Production:** Use CPU features for stable deployments" >> $GITHUB_STEP_SUMMARY
        echo "- ğŸ³ **Containers:** Use minimal features for smaller images" >> $GITHUB_STEP_SUMMARY 
        echo "- ğŸš€ **Workstations:** Use GPU features if CUDA available" >> $GITHUB_STEP_SUMMARY
        echo "- ğŸ”§ **Development:** Default features include CPU optimizations" >> $GITHUB_STEP_SUMMARY

  # Integration tests Ñ real embedding API
  integration-tests:
    name: ğŸ§ª Integration Tests
    runs-on: ubuntu-latest
    needs: feature-matrix
    if: github.event.inputs.release_mode == 'true'
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ“¦ Download CPU binary
      uses: actions/download-artifact@v4
      with:
        name: magray-cpu-linux
        path: ./bin
        
    - name: ğŸ”§ Setup binary permissions
      run: chmod +x ./bin/magray
      
    - name: ğŸ§ª Test basic functionality
      run: |
        echo "Testing basic CLI functionality..."
        ./bin/magray --version
        
        echo "Testing status command..."
        ./bin/magray status
        
        echo "âœ… Basic integration tests passed"