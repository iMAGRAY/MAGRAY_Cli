name: üîí Advanced Security Scanning

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # –ï–∂–µ–¥–Ω–µ–≤–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –≤ 02:00 UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      scan_type:
        description: 'Type of security scan'
        required: true
        default: 'full'
        type: choice
        options:
          - full
          - dependency
          - sast
          - secrets

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  # =========================================
  # DEPENDENCY VULNERABILITY SCANNING
  # =========================================
  dependency-scan:
    name: üîç Dependency Vulnerability Scan
    runs-on: ubuntu-latest
    if: github.event.inputs.scan_type == 'full' || github.event.inputs.scan_type == 'dependency' || github.event_name != 'workflow_dispatch'
    permissions:
      security-events: write
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: üîß Install Rust Toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: üõ°Ô∏è Cargo Audit - Critical Vulnerabilities
        run: |
          cargo install cargo-audit
          echo "## Cargo Audit Report" > security-report.md
          echo "Date: $(date)" >> security-report.md
          echo "" >> security-report.md
          
          if ! cargo audit --json > audit-results.json 2>&1; then
            echo "‚ùå CRITICAL: Security vulnerabilities found!"
            echo "### Critical Vulnerabilities Found:" >> security-report.md
            cat audit-results.json | jq -r '.vulnerabilities[] | "- **" + .advisory.id + "**: " + .advisory.title' >> security-report.md
            
            # Fail –Ω–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —É—è–∑–≤–∏–º–æ—Å—Ç—è—Ö
            CRITICAL_COUNT=$(cat audit-results.json | jq '.vulnerabilities | length')
            if (( CRITICAL_COUNT > 0 )); then
              echo "Found $CRITICAL_COUNT critical vulnerabilities - blocking merge!"
              exit 1
            fi
          else
            echo "‚úÖ No critical vulnerabilities found"
            echo "### ‚úÖ No Critical Vulnerabilities Detected" >> security-report.md
          fi

      - name: üîç Advanced Dependency Analysis
        run: |
          # –ü—Ä–æ–≤–µ—Ä–∫–∞ dependency tree –Ω–∞ suspicious packages
          cargo tree --format "{p} {f}" > dependency-tree.txt
          
          echo "" >> security-report.md
          echo "### Dependency Analysis" >> security-report.md
          echo "Total dependencies: $(cargo tree --format '{p}' | wc -l)" >> security-report.md
          
          # –ü–æ–∏—Å–∫ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ –ø—Ä–æ–±–ª–µ–º–∞—Ç–∏—á–Ω—ã—Ö dependencies
          if grep -i -E "(crypto|network|unsafe|sys|ffi)" dependency-tree.txt; then
            echo "‚ö†Ô∏è Found potentially sensitive dependencies"
            echo "### ‚ö†Ô∏è Sensitive Dependencies Detected:" >> security-report.md
            grep -i -E "(crypto|network|unsafe|sys|ffi)" dependency-tree.txt >> security-report.md
          fi

      - name: üìä Supply Chain Risk Assessment
        run: |
          echo "" >> security-report.md
          echo "### Supply Chain Risk Assessment" >> security-report.md
          
          # –ê–Ω–∞–ª–∏–∑ –Ω–µ–ø—Ä—è–º—ã—Ö dependencies
          TOTAL_DEPS=$(cargo tree --format '{p}' | sort -u | wc -l)
          DIRECT_DEPS=$(grep -c "^[a-zA-Z]" Cargo.toml || echo 0)
          INDIRECT_DEPS=$((TOTAL_DEPS - DIRECT_DEPS))
          
          echo "- Direct dependencies: $DIRECT_DEPS" >> security-report.md
          echo "- Indirect dependencies: $INDIRECT_DEPS" >> security-report.md
          echo "- Risk ratio: $(echo "scale=2; $INDIRECT_DEPS / $DIRECT_DEPS" | bc)" >> security-report.md
          
          if (( INDIRECT_DEPS > 100 )); then
            echo "‚ö†Ô∏è HIGH RISK: Too many indirect dependencies ($INDIRECT_DEPS)"
            echo "- **HIGH RISK**: Excessive indirect dependencies detected" >> security-report.md
          fi

      - name: üì§ Upload Security Report
        uses: actions/upload-artifact@v3
        with:
          name: dependency-security-report
          path: security-report.md

  # =========================================
  # STATIC APPLICATION SECURITY TESTING (SAST)
  # =========================================
  sast-analysis:
    name: üïµÔ∏è SAST Analysis
    runs-on: ubuntu-latest
    if: github.event.inputs.scan_type == 'full' || github.event.inputs.scan_type == 'sast' || github.event_name != 'workflow_dispatch'
    permissions:
      security-events: write
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: üîß Install Rust Security Tools
        run: |
          # Clippy —Å security lints
          rustup component add clippy
          
          # cargo-geiger –¥–ª—è unsafe code detection
          cargo install cargo-geiger
          
          # cargo-pants –¥–ª—è license compliance
          cargo install cargo-pants

      - name: üîí Enhanced Clippy Security Analysis
        run: |
          echo "## SAST Security Analysis" > sast-report.md
          echo "Date: $(date)" >> sast-report.md
          echo "" >> sast-report.md
          
          # Clippy —Å –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ —Å—Ç—Ä–æ–≥–∏–º–∏ security –ø—Ä–∞–≤–∏–ª–∞–º–∏
          cargo clippy --workspace --all-targets --all-features -- \
            -D warnings \
            -D clippy::all \
            -D clippy::pedantic \
            -D clippy::nursery \
            -D clippy::cargo \
            -D clippy::suspicious \
            -D clippy::perf \
            -W clippy::unwrap_used \
            -W clippy::expect_used \
            -W clippy::panic \
            -W clippy::unimplemented \
            -W clippy::todo \
            -W clippy::unreachable \
            -A clippy::too_many_arguments \
            -A clippy::module_name_repetitions \
            -A clippy::missing_errors_doc \
            2>&1 | tee clippy-security.log
          
          if grep -q "error\|warning" clippy-security.log; then
            echo "### ‚ö†Ô∏è Security Issues Found:" >> sast-report.md
            grep "error\|warning" clippy-security.log | head -20 >> sast-report.md
          else
            echo "### ‚úÖ No Security Issues Detected" >> sast-report.md
          fi

      - name: ‚ò¢Ô∏è Unsafe Code Analysis
        run: |
          echo "" >> sast-report.md
          echo "### Unsafe Code Analysis" >> sast-report.md
          
          # –ü–æ–¥—Å—á–µ—Ç unsafe –±–ª–æ–∫–æ–≤
          if cargo geiger --format json > geiger-report.json 2>/dev/null; then
            UNSAFE_COUNT=$(cat geiger-report.json | jq '.crates[] | select(.crate_name | startswith("magray")) | .metrics.counters.functions.unsafe_')
            echo "- Unsafe functions found: $UNSAFE_COUNT" >> sast-report.md
            
            if (( UNSAFE_COUNT > 10 )); then
              echo "‚ö†Ô∏è HIGH RISK: Too many unsafe functions ($UNSAFE_COUNT)"
              echo "- **HIGH RISK**: Excessive unsafe code detected" >> sast-report.md
            elif (( UNSAFE_COUNT > 0 )); then
              echo "‚ö†Ô∏è MEDIUM RISK: Some unsafe code present ($UNSAFE_COUNT)"
              echo "- **MEDIUM RISK**: Unsafe code requires review" >> sast-report.md
            else
              echo "‚úÖ No unsafe code detected"
              echo "- **LOW RISK**: No unsafe code detected" >> sast-report.md
            fi
          else
            echo "- Could not analyze unsafe code usage" >> sast-report.md
          fi

      - name: üìú License Compliance Check
        run: |
          echo "" >> sast-report.md
          echo "### License Compliance" >> sast-report.md
          
          # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏—Ü–µ–Ω–∑–∏–π dependencies
          if cargo pants 2>&1 | tee license-report.txt; then
            echo "#### License Summary:" >> sast-report.md
            grep -E "(MIT|Apache|BSD|GPL)" license-report.txt | sort | uniq -c >> sast-report.md
            
            # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø—Ä–æ–±–ª–µ–º–∞—Ç–∏—á–Ω—ã–µ –ª–∏—Ü–µ–Ω–∑–∏–∏
            if grep -i -E "(GPL-3|AGPL|SSPL|Commons Clause)" license-report.txt; then
              echo "‚ùå CRITICAL: Restrictive licenses found!"
              echo "- **CRITICAL**: Restrictive licenses detected" >> sast-report.md
              exit 1
            fi
          fi

      - name: üîç Code Pattern Security Analysis
        run: |
          echo "" >> sast-report.md
          echo "### Security Pattern Analysis" >> sast-report.md
          
          # –ü–æ–∏—Å–∫ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ –æ–ø–∞—Å–Ω—ã—Ö –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ –≤ –∫–æ–¥–µ
          DANGEROUS_PATTERNS=0
          
          # SQL injection –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª
          if find crates -name "*.rs" -exec grep -l "format!\|write!\|sql\|query" {} \; | head -5; then
            echo "‚ö†Ô∏è Found potential SQL injection vectors"
            echo "- **MEDIUM RISK**: SQL query construction patterns found" >> sast-report.md
            ((DANGEROUS_PATTERNS++))
          fi
          
          # Command injection –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª  
          if find crates -name "*.rs" -exec grep -l "Command\|spawn\|exec" {} \; | head -5; then
            echo "‚ö†Ô∏è Found potential command injection vectors"
            echo "- **MEDIUM RISK**: Command execution patterns found" >> sast-report.md
            ((DANGEROUS_PATTERNS++))
          fi
          
          # Hardcoded secrets (basic check)
          if find crates -name "*.rs" -exec grep -i -E "(password|secret|token|key).*=.*\"" {} \; | head -5; then
            echo "‚ö†Ô∏è Potential hardcoded secrets found"
            echo "- **HIGH RISK**: Potential hardcoded secrets detected" >> sast-report.md
            ((DANGEROUS_PATTERNS++))
          fi
          
          echo "- Total security patterns found: $DANGEROUS_PATTERNS" >> sast-report.md

      - name: üì§ Upload SAST Report
        uses: actions/upload-artifact@v3
        with:
          name: sast-security-report
          path: sast-report.md

  # =========================================
  # SECRET SCANNING & CREDENTIAL DETECTION
  # =========================================
  secret-scanning:
    name: üîê Secret & Credential Scanning
    runs-on: ubuntu-latest
    if: github.event.inputs.scan_type == 'full' || github.event.inputs.scan_type == 'secrets' || github.event_name != 'workflow_dispatch'
    permissions:
      security-events: write
      contents: read
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history –¥–ª—è comprehensive scanning

      - name: üïµÔ∏è TruffleHog Secret Scanning
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: main
          head: HEAD
          extra_args: --debug --only-verified --json --output=trufflehog-results.json

      - name: üìä Process TruffleHog Results
        run: |
          echo "## Secret Scanning Report" > secrets-report.md
          echo "Date: $(date)" >> secrets-report.md
          echo "" >> secrets-report.md
          
          if [[ -f "trufflehog-results.json" && -s "trufflehog-results.json" ]]; then
            SECRET_COUNT=$(jq '. | length' trufflehog-results.json)
            echo "### üö® CRITICAL: $SECRET_COUNT Secrets Found!" >> secrets-report.md
            echo "" >> secrets-report.md
            
            # –î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö —Å–µ–∫—Ä–µ—Ç–æ–≤
            jq -r '.[] | "- **" + .detector_name + "**: " + .raw' trufflehog-results.json | head -10 >> secrets-report.md
            
            if (( SECRET_COUNT > 0 )); then
              echo "‚ùå CRITICAL: Secrets found in repository!"
              echo "This blocks the build until secrets are removed."
              exit 1
            fi
          else
            echo "### ‚úÖ No Secrets Detected" >> secrets-report.md
          fi

      - name: üîç Custom Secret Pattern Detection
        run: |
          echo "" >> secrets-report.md
          echo "### Custom Pattern Analysis" >> secrets-report.md
          
          # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã specific –¥–ª—è AI/ML –ø—Ä–æ–µ–∫—Ç–æ–≤
          PATTERNS_FOUND=0
          
          # API keys patterns
          if find . -type f -name "*.rs" -o -name "*.toml" -o -name "*.yaml" -o -name "*.json" | \
             xargs grep -i -E "(api[_-]?key|auth[_-]?token|access[_-]?token)" | grep -v test; then
            echo "‚ö†Ô∏è Potential API key patterns found"
            echo "- **HIGH RISK**: API key patterns detected" >> secrets-report.md
            ((PATTERNS_FOUND++))
          fi
          
          # OpenAI/Anthropic API patterns
          if find . -type f -name "*.rs" -o -name "*.toml" | \
             xargs grep -i -E "(openai|anthropic|claude).*key" | grep -v test; then
            echo "‚ö†Ô∏è LLM API key patterns found"
            echo "- **CRITICAL**: LLM API key patterns detected" >> secrets-report.md
            ((PATTERNS_FOUND++))
          fi
          
          # Database connection strings
          if find . -type f -name "*.rs" -o -name "*.toml" | \
             xargs grep -i -E "(database_url|db_url|connection_string)" | grep -v test | grep -v example; then
            echo "‚ö†Ô∏è Database connection patterns found"
            echo "- **MEDIUM RISK**: Database connection patterns detected" >> secrets-report.md
            ((PATTERNS_FOUND++))
          fi
          
          if (( PATTERNS_FOUND == 0 )); then
            echo "- **LOW RISK**: No suspicious patterns detected" >> secrets-report.md
          fi
          
          echo "- Custom patterns analyzed: $PATTERNS_FOUND" >> secrets-report.md

      - name: üìù Git History Secret Analysis
        run: |
          echo "" >> secrets-report.md
          echo "### Git History Analysis" >> secrets-report.md
          
          # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å–ª—É—á–∞–π–Ω–æ –∑–∞–∫–æ–º–º–∏—á–µ–Ω–Ω—ã–µ —Å–µ–∫—Ä–µ—Ç—ã –≤ –∏—Å—Ç–æ—Ä–∏–∏
          SUSPICIOUS_COMMITS=$(git log --all --full-history --grep="password\|secret\|key\|token" --oneline | wc -l)
          echo "- Suspicious commits in history: $SUSPICIOUS_COMMITS" >> secrets-report.md
          
          if (( SUSPICIOUS_COMMITS > 0 )); then
            echo "‚ö†Ô∏è Suspicious commits found in git history"
            echo "- **MEDIUM RISK**: Suspicious commits in git history" >> secrets-report.md
            git log --all --full-history --grep="password\|secret\|key\|token" --oneline | head -5 >> secrets-report.md
          fi
          
          # –ë–æ–ª—å—à–∏–µ —Ñ–∞–π–ª—ã (–º–æ–≥—É—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–æ–¥–µ–ª–∏/—Å–µ–∫—Ä–µ—Ç—ã)
          LARGE_FILES=$(find . -type f -size +10M | grep -v target | grep -v .git | wc -l)
          echo "- Large files (>10MB): $LARGE_FILES" >> secrets-report.md
          
          if (( LARGE_FILES > 5 )); then
            echo "‚ö†Ô∏è Many large files detected"
            echo "- **LOW RISK**: Many large files (potential secret storage)" >> secrets-report.md
          fi

      - name: üì§ Upload Secrets Report
        uses: actions/upload-artifact@v3
        with:
          name: secrets-security-report
          path: secrets-report.md

  # =========================================
  # COMPREHENSIVE SECURITY SUMMARY
  # =========================================
  security-summary:
    name: üìã Security Summary Report
    runs-on: ubuntu-latest
    needs: [dependency-scan, sast-analysis, secret-scanning]
    if: always()
    permissions:
      security-events: write
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: üì• Download All Security Reports
        uses: actions/download-artifact@v3
        with:
          pattern: '*security-report'
          path: security-reports/

      - name: üìä Generate Comprehensive Security Report
        run: |
          echo "# üîí MAGRAY CLI Security Assessment Report" > SECURITY_ASSESSMENT.md
          echo "**Date**: $(date)" >> SECURITY_ASSESSMENT.md
          echo "**Commit**: ${{ github.sha }}" >> SECURITY_ASSESSMENT.md
          echo "" >> SECURITY_ASSESSMENT.md
          
          # –°–≤–æ–¥–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
          echo "## Executive Summary" >> SECURITY_ASSESSMENT.md
          echo "" >> SECURITY_ASSESSMENT.md
          
          # –°—Ç–∞—Ç—É—Å –∫–∞–∂–¥–æ–≥–æ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
          echo "### Scan Results:" >> SECURITY_ASSESSMENT.md
          echo "- **Dependency Scan**: ${{ needs.dependency-scan.result }}" >> SECURITY_ASSESSMENT.md
          echo "- **SAST Analysis**: ${{ needs.sast-analysis.result }}" >> SECURITY_ASSESSMENT.md
          echo "- **Secret Scanning**: ${{ needs.secret-scanning.result }}" >> SECURITY_ASSESSMENT.md
          echo "" >> SECURITY_ASSESSMENT.md
          
          # –û–±—â–∏–π —Å—Ç–∞—Ç—É—Å –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
          FAILED_SCANS=0
          [[ "${{ needs.dependency-scan.result }}" != "success" ]] && ((FAILED_SCANS++))
          [[ "${{ needs.sast-analysis.result }}" != "success" ]] && ((FAILED_SCANS++))
          [[ "${{ needs.secret-scanning.result }}" != "success" ]] && ((FAILED_SCANS++))
          
          if (( FAILED_SCANS == 0 )); then
            echo "## ‚úÖ SECURITY STATUS: PASSED" >> SECURITY_ASSESSMENT.md
            echo "All security scans passed successfully." >> SECURITY_ASSESSMENT.md
          elif (( FAILED_SCANS == 1 )); then
            echo "## ‚ö†Ô∏è SECURITY STATUS: WARNING" >> SECURITY_ASSESSMENT.md
            echo "One security scan failed - review required." >> SECURITY_ASSESSMENT.md
          else
            echo "## ‚ùå SECURITY STATUS: CRITICAL" >> SECURITY_ASSESSMENT.md
            echo "Multiple security scans failed - immediate action required." >> SECURITY_ASSESSMENT.md
          fi
          
          echo "" >> SECURITY_ASSESSMENT.md
          
          # –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –≤—Å–µ—Ö –æ—Ç—á–µ—Ç–æ–≤
          echo "## Detailed Reports" >> SECURITY_ASSESSMENT.md
          echo "" >> SECURITY_ASSESSMENT.md
          
          for report_dir in security-reports/*/; do
            if [[ -d "$report_dir" ]]; then
              for report_file in "$report_dir"*.md; do
                if [[ -f "$report_file" ]]; then
                  echo "### $(basename "$report_dir" | sed 's/-security-report//')" >> SECURITY_ASSESSMENT.md
                  echo "" >> SECURITY_ASSESSMENT.md
                  cat "$report_file" >> SECURITY_ASSESSMENT.md
                  echo "" >> SECURITY_ASSESSMENT.md
                  echo "---" >> SECURITY_ASSESSMENT.md
                  echo "" >> SECURITY_ASSESSMENT.md
                fi
              done
            fi
          done

      - name: üö® Security Quality Gate
        run: |
          FAILED_SCANS=0
          [[ "${{ needs.dependency-scan.result }}" != "success" ]] && ((FAILED_SCANS++))
          [[ "${{ needs.sast-analysis.result }}" != "success" ]] && ((FAILED_SCANS++))
          [[ "${{ needs.secret-scanning.result }}" != "success" ]] && ((FAILED_SCANS++))
          
          echo "Security Assessment Summary:"
          echo "- Failed scans: $FAILED_SCANS/3"
          echo "- Overall status: ${{ needs.dependency-scan.result }}, ${{ needs.sast-analysis.result }}, ${{ needs.secret-scanning.result }}"
          
          # –ù–∞ main branch –∫—Ä–∏—Ç–∏—á–Ω—ã–µ –æ—à–∏–±–∫–∏ –±–ª–æ–∫–∏—Ä—É—é—Ç merge
          if [[ "${{ github.ref }}" == "refs/heads/main" ]] && (( FAILED_SCANS > 0 )); then
            echo "‚ùå SECURITY GATE FAILED: Cannot merge to main with security issues!"
            echo "Please fix security issues before merging."
            exit 1
          elif (( FAILED_SCANS > 1 )); then
            echo "‚ùå SECURITY GATE FAILED: Multiple critical security issues found!"
            exit 1
          else
            echo "‚úÖ SECURITY GATE PASSED: All security checks completed successfully!"
          fi

      - name: üì§ Upload Comprehensive Security Report
        uses: actions/upload-artifact@v3
        with:
          name: comprehensive-security-assessment
          path: SECURITY_ASSESSMENT.md

      # –í production –∑–¥–µ—Å—å –±—ã–ª–∏ –±—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è security team
      - name: üîî Security Notification (Mock)
        if: failure()
        run: |
          echo "=== SECURITY ALERT ==="
          echo "Repository: ${{ github.repository }}"
          echo "Commit: ${{ github.sha }}"
          echo "Failed scans: $FAILED_SCANS"
          echo "Requires immediate security team attention!"
          echo "========================"
          
          # Mock notification - –≤ production –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å:
          # - Security team Slack channel
          # - PagerDuty for critical issues
          # - JIRA ticket creation
          # - Email notifications to security team