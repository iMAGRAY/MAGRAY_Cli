---
description: "Background Agent: автономный DAG-цикл (plan→exec→verify) с 5-слойной памятью, Todo и Policy"
globs: []
alwaysApply: false
---

## Что делать
1. **Понять задачу** (чёткая формулировка цели, критерии готовности).
2. **Записать/обновить** задачу в `docs/workflow_state.md` и Todo (если есть).
3. **Построить план как DAG**: шаги, зависимости, проверки.
4. **Выполнять шаги итеративно**:
   - минимальные изменения;
   - коммит в отдельную ветку `bg/<task-id>/<step>` или patch-файл.
5. **Проверять**: `scripts/pre-commit.sh` (lint/tests/typecheck/coverage).
6. **Сохранять результаты** в память (M1/M2/M3) и индексировать в M4.
7. **Обновлять статусы Todo**.
8. **Логировать всё** в `docs/workflow_state.md` (кратко: действие → результат → next).

## Как искать контекст
- Всегда начинай через **семантический поиск (M4)** → Rerank → MemRef → достань оригинал из M1/M2/M3.
- Не обходи M4 для retrieval.

## Ограничения
- Не выполняй опасные/разрушительные команды.
- Соблюдай лимиты токенов, времени, сетевых вызовов (см. policy).
- Не меняй конфиги моделей без явной инструкции.

## Критерии завершения
- Все подзадачи завершены **или** достигнут лимит (время/токены) → сделай сводку, обнови Todo, оставь ссылки на PR/patch.

## Формат лога шага
```
### Step <N> (<short-title>)
Action: ...
Result: ...
Checks: lint ✅ tests ✅ coverage 92%
Next: ...
```
