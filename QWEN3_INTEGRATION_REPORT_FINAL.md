# –û—Ç—á—ë—Ç –æ–± –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ Qwen3 –≤ —Å–∏—Å—Ç–µ–º—É –ø–∞–º—è—Ç–∏ MAGRAY

üÜï **–û–ë–ù–û–í–õ–ï–ù–û**: –¢–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ù–ê–°–¢–û–Ø–©–ò–ô —Ç–æ–∫–µ–Ω–∏–∑–∞—Ç–æ—Ä Qwen3!

## –ß—Ç–æ –±—ã–ª–æ —Å–¥–µ–ª–∞–Ω–æ ‚úÖ

1. **–ò–∑–º–µ–Ω–µ–Ω–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é**:
   - Embedding –º–æ–¥–µ–ª—å: `bge-m3` ‚Üí `qwen3emb`
   - Reranking –º–æ–¥–µ–ª—å: `BGE-reranker-v2-m3` ‚Üí `qwen3_reranker`
   - –§–∞–π–ª—ã –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –æ–±–Ω–æ–≤–ª–µ–Ω—ã –≤ `crates/ai/src/config.rs`

2. **–û–±–Ω–æ–≤–ª–µ–Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –º–æ–¥–µ–ª–µ–π –≤ embedding —Å–µ—Ä–≤–∏—Å–µ**:
   - –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∞ `.opt.onnx` —Ñ–∞–π–ª–æ–≤ –¥–ª—è Qwen3
   - –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –º–æ–¥–µ–ª–µ–π —Å 2 –≤—Ö–æ–¥–∞–º–∏ (Qwen3) vs 3 –≤—Ö–æ–¥–∞–º–∏ (BGE-M3)
   - –û–±–Ω–æ–≤–ª—ë–Ω —Ñ–∞–π–ª `crates/ai/src/embeddings_cpu.rs`

3. **–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∞ —Ç–æ–∫–µ–Ω–∏–∑–∞—Ç–æ—Ä–∞ Qwen3**:
   - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è **–ù–ê–°–¢–û–Ø–©–ò–ô** tokenizer.json –∏–∑ –º–æ–¥–µ–ª–∏
   - –°–æ–∑–¥–∞–Ω fallback `SimpleQwen3Tokenizer` –¥–ª—è —Å–ª—É—á–∞–µ–≤ —Å–±–æ—è
   - –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω –≤ —Å–∏—Å—Ç–µ–º—É —á–µ—Ä–µ–∑ `TokenizerImpl` enum
   - –§–∞–π–ª—ã: `crates/ai/src/tokenization/simple_qwen3.rs` –∏ `mod.rs`

4. **–°–æ–∑–¥–∞–Ω –ø–æ–ª–Ω—ã–π –Ω–∞–±–æ—Ä —Ç–µ—Å—Ç–æ–≤**:
   - `test_qwen3_models.rs` - –∫–æ–º–ø–ª–µ–∫—Å–Ω—ã–π —Ç–µ—Å—Ç embedding –∏ reranking
   - `check_default_models.rs` - –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
   - `test_qwen3_simple.rs` - –ø—Ä–æ—Å—Ç–æ–π —Ç–µ—Å—Ç –±–µ–∑ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
   - `test_real_tokenizer.rs` - —Ç–µ—Å—Ç —Ä–∞–±–æ—Ç—ã –Ω–∞—Å—Ç–æ—è—â–µ–≥–æ —Ç–æ–∫–µ–Ω–∏–∑–∞—Ç–æ—Ä–∞

## üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–æ–≤:

```
‚úÖ Embedding —Å–µ—Ä–≤–∏—Å —Å–æ–∑–¥–∞–Ω!
‚úÖ Embedding –ø–æ–ª—É—á–µ–Ω:
   –†–∞–∑–º–µ—Ä–Ω–æ—Å—Ç—å: 1024
   –ü–µ—Ä–≤—ã–µ 5 –∑–Ω–∞—á–µ–Ω–∏–π: [-0.05355625, 0.0275295, -0.021685477, -0.060209945, 0.0254764]
   L2 –Ω–æ—Ä–º–∞: 1.0000

‚úÖ –ë–∞—Ç—á embeddings –ø–æ–ª—É—á–µ–Ω—ã:
   –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ: 3
   Text 1: 1024 dimensions, L2 norm: 1.0000
   Text 2: 1024 dimensions, L2 norm: 1.0000
   Text 3: 1024 dimensions, L2 norm: 1.0000

‚úÖ Reranking —Å–µ—Ä–≤–∏—Å —Å–æ–∑–¥–∞–Ω!
‚úÖ Reranking scores:
   "–ü–æ–≥–æ–¥–∞ —Å–µ–≥–æ–¥–Ω—è —Ö–æ—Ä–æ—à–∞—è": 0.2267
   "–ú–∞—à–∏–Ω–Ω–æ–µ –æ–±—É—á–µ–Ω–∏–µ - —ç—Ç–æ –ø–æ–¥—Ä–∞–∑–¥–µ–ª –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç–∞": 0.1799
   "ML –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –¥–∞–Ω–Ω—ã—Ö –∏ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–π": 0.1660
```

## ‚ùå –ß–¢–û –ù–ï –°–î–ï–õ–ê–ù–û:

- **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–æ–∫–µ–Ω–∏–∑–∞—Ç–æ—Ä–∞**: –ù–µ –≤—Å–µ–≥–¥–∞ tokenizer.json –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- **GPU –ø–æ–¥–¥–µ—Ä–∂–∫–∞**: –ú–æ–¥–µ–ª–∏ —Ä–∞–±–æ—Ç–∞—é—Ç —Ç–æ–ª—å–∫–æ –Ω–∞ CPU, GPU —É—Å–∫–æ—Ä–µ–Ω–∏–µ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ
- **Batch –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è**: –ë–∞—Ç—á –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç, –Ω–æ –Ω–µ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ –¥–ª—è Qwen3
- **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–æ–∫–µ–Ω–∏–∑–∞—Ü–∏–∏**: –ü–æ–≤—Ç–æ—Ä–Ω–∞—è —Ç–æ–∫–µ–Ω–∏–∑–∞—Ü–∏—è –æ–¥–∏–Ω–∞–∫–æ–≤—ã—Ö —Ç–µ–∫—Å—Ç–æ–≤ –Ω–µ –∫—ç—à–∏—Ä—É–µ—Ç—Å—è
- **–ú–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏**: –ù–µ—Ç –∑–∞–º–µ—Ä–æ–≤ —Å–∫–æ—Ä–æ—Å—Ç–∏ –∏ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏—è –ø–∞–º—è—Ç–∏

## ‚ö†Ô∏è –û–ì–†–ê–ù–ò–ß–ï–ù–ò–Ø:

- **Fallback —Ç–æ–∫–µ–Ω–∏–∑–∞—Ü–∏—è**: –ï—Å–ª–∏ –Ω–∞—Å—Ç–æ—è—â–∏–π —Ç–æ–∫–µ–Ω–∏–∑–∞—Ç–æ—Ä –Ω–µ –∑–∞–≥—Ä—É–∑–∏—Ç—Å—è, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —É–ø—Ä–æ—â—ë–Ω–Ω—ã–π
- **–ù–µ—Ç –≤–∞–ª–∏–¥–∞—Ü–∏–∏ vocab_size**: –ë–µ—Ä—ë—Ç—Å—è –∏–∑ config.json –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–µ—Ñ–æ–ª—Ç
- **–§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ special tokens**: –•–∞—Ä–¥–∫–æ–¥ ID –¥–ª—è <|endoftext|>, <|im_start|>, <|im_end|>
- **–ü—Ä–æ—Å—Ç–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å–ª–æ–≤**: split_whitespace() –≤–º–µ—Å—Ç–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Å–µ–≥–º–µ–Ω—Ç–∞—Ü–∏–∏ –≤ fallback
- **–ù–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–ª–∏–Ω–Ω—ã—Ö —Ç–µ–∫—Å—Ç–æ–≤**: –ü—Ä–æ—Å—Ç–æ–µ –æ–±—Ä–µ–∑–∞–Ω–∏–µ –±–µ–∑ —É—á—ë—Ç–∞ –≥—Ä–∞–Ω–∏—Ü —Ç–æ–∫–µ–Ω–æ–≤

## üîß –¢–ï–•–ù–ò–ß–ï–°–ö–ò–ô –î–û–õ–ì:

- `simple_encode()` –º–µ—Ç–æ–¥ –≤ tokenization/mod.rs –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è (dead code)
- `special_tokens` HashMap —Å–æ–∑–¥–∞—ë—Ç—Å—è –Ω–æ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ SimpleQwen3Tokenizer
- –•–∞—Ä–¥–∫–æ–¥ —Ä–∞–∑–º–µ—Ä–Ω–æ—Å—Ç–∏ embeddings (1024) –≤ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –º–µ—Å—Ç–∞—Ö
- –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–≥–∏–∫–∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –º–æ–¥–µ–ª–∏ –ø–æ –ø—É—Ç–∏
- –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ unit —Ç–µ—Å—Ç–æ–≤ –¥–ª—è SimpleQwen3Tokenizer

## üìã –°–õ–ï–î–£–Æ–©–ò–ï –®–ê–ì–ò:

1. **–£–ª—É—á—à–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫ —Ç–æ–∫–µ–Ω–∏–∑–∞—Ç–æ—Ä–∞**:
   - –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–∏—á–∏–Ω –Ω–µ—É–¥–∞—á–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏
   - –î–æ–±–∞–≤–∏—Ç—å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤

2. **–î–æ–±–∞–≤–∏—Ç—å GPU –ø–æ–¥–¥–µ—Ä–∂–∫—É**:
   - –ù–∞—Å—Ç—Ä–æ–∏—Ç—å CUDA execution provider
   - –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤—ã–±–æ—Ä CPU/GPU
   - –î–æ–±–∞–≤–∏—Ç—å –±–∞—Ç—á –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—é –¥–ª—è GPU

3. **–£–ª—É—á—à–∏—Ç—å –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**:
   - –ü—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—É—â—É—é —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é
   - –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –±–∞—Ç—á –æ–±—Ä–∞–±–æ—Ç–∫—É
   - –î–æ–±–∞–≤–∏—Ç—å memory pooling –¥–ª—è —Ç–æ–∫–µ–Ω–∏–∑–∞—Ç–æ—Ä–∞

4. **–î–æ–±–∞–≤–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥**:
   - –ú–µ—Ç—Ä–∏–∫–∏ –≤—Ä–µ–º–µ–Ω–∏ inference
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏
   - –ö–∞—á–µ—Å—Ç–≤–æ embeddings (–∫–æ—Å–∏–Ω—É—Å–Ω–æ–µ —Å—Ö–æ–¥—Å—Ç–≤–æ)

## üìä –ß–ï–°–¢–ù–ê–Ø –ì–û–¢–û–í–ù–û–°–¢–¨: 85%

–û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å —Ä–∞–±–æ—Ç–∞–µ—Ç - –º–æ–¥–µ–ª–∏ Qwen3 —É—Å–ø–µ—à–Ω–æ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –¥–ª—è embeddings –∏ reranking —Å –Ω–∞—Å—Ç–æ—è—â–∏–º —Ç–æ–∫–µ–Ω–∏–∑–∞—Ç–æ—Ä–æ–º. –î–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞ –Ω—É–∂–Ω–∞ GPU –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏.

## üìÅ –í–∞–∂–Ω—ã–µ —Ñ–∞–π–ª—ã –≤ –º–æ–¥–µ–ª–∏ Qwen3:

```
crates/memory/models/qwen3emb/
‚îú‚îÄ‚îÄ tokenizer.json      # –û—Å–Ω–æ–≤–Ω–æ–π —Ñ–∞–π–ª —Ç–æ–∫–µ–Ω–∏–∑–∞—Ç–æ—Ä–∞
‚îú‚îÄ‚îÄ vocab.json          # –°–ª–æ–≤–∞—Ä—å —Ç–æ–∫–µ–Ω–æ–≤
‚îú‚îÄ‚îÄ merges.txt          # –ü—Ä–∞–≤–∏–ª–∞ —Å–ª–∏—è–Ω–∏—è BPE
‚îú‚îÄ‚îÄ config.json         # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –º–æ–¥–µ–ª–∏
‚îî‚îÄ‚îÄ model.opt.onnx      # –ö–≤–∞–Ω—Ç–æ–≤–∞–Ω–Ω–∞—è ONNX –º–æ–¥–µ–ª—å
```

## –ö–æ–º–∞–Ω–¥—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏:

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
cargo run --example check_default_models --package ai

# –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–æ—Å—Ç–æ–π —Ç–µ—Å—Ç –±–µ–∑ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
cargo run --example test_qwen3_simple --package ai

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç—É –Ω–∞—Å—Ç–æ—è—â–µ–≥–æ —Ç–æ–∫–µ–Ω–∏–∑–∞—Ç–æ—Ä–∞
cargo run --example test_real_tokenizer --package ai
```