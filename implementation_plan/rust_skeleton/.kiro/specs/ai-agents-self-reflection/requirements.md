# Requirements Document

## Introduction

Данная спецификация описывает улучшение AI агентов в MAGRAY CLI для добавления процесса самоанализа, самопроверки и улучшения решений. Каждый агент должен следовать структурированному процессу: анализ задачи → создание решения → сомнение и перепроверка → улучшение решения.

## Requirements

### Requirement 1: Структурированный процесс принятия решений

**User Story:** Как разработчик системы, я хочу чтобы AI агенты следовали структурированному процессу принятия решений, чтобы повысить качество и надежность их работы.

#### Acceptance Criteria

1. WHEN агент получает задачу THEN он SHALL сначала проанализировать задачу и понять контекст
2. WHEN анализ завершен THEN агент SHALL создать первоначальное решение согласно своей роли
3. WHEN решение создано THEN агент SHALL усомниться в решении и найти потенциальные проблемы
4. WHEN проблемы выявлены THEN агент SHALL перепроверить решение и при возможности улучшить его
5. WHEN процесс завершен THEN агент SHALL предоставить финальное решение с обоснованием

### Requirement 2: Самоанализ для ToolSelectorAgent

**User Story:** Как пользователь системы, я хочу чтобы ToolSelectorAgent тщательно анализировал мой запрос и выбирал наиболее подходящий инструмент, чтобы получить точный результат.

#### Acceptance Criteria

1. WHEN ToolSelectorAgent получает запрос THEN он SHALL проанализировать ключевые слова и контекст
2. WHEN анализ завершен THEN он SHALL выбрать наиболее подходящий инструмент
3. WHEN выбор сделан THEN он SHALL усомниться: "А точно ли это лучший выбор?"
4. WHEN сомнения возникли THEN он SHALL рассмотреть альтернативные инструменты
5. WHEN альтернативы рассмотрены THEN он SHALL подтвердить или изменить свой выбор

### Requirement 3: Самопроверка для ParameterExtractorAgent

**User Story:** Как пользователь системы, я хочу чтобы ParameterExtractorAgent точно извлекал параметры из моего запроса, чтобы команды выполнялись корректно.

#### Acceptance Criteria

1. WHEN ParameterExtractorAgent получает запрос THEN он SHALL проанализировать структуру запроса
2. WHEN анализ завершен THEN он SHALL извлечь параметры согласно схеме инструмента
3. WHEN параметры извлечены THEN он SHALL усомниться: "Все ли параметры корректны?"
4. WHEN сомнения возникли THEN он SHALL проверить каждый параметр на соответствие требованиям
5. WHEN проверка завершена THEN он SHALL исправить ошибки или подтвердить корректность

### Requirement 4: Критическое мышление для IntentAnalyzerAgent

**User Story:** Как пользователь системы, я хочу чтобы IntentAnalyzerAgent точно определял мои намерения, чтобы система выбирала правильный тип ответа (chat или tools).

#### Acceptance Criteria

1. WHEN IntentAnalyzerAgent получает запрос THEN он SHALL проанализировать намерения пользователя
2. WHEN анализ завершен THEN он SHALL классифицировать запрос как "chat" или "tools"
3. WHEN классификация сделана THEN он SHALL усомниться: "А может пользователь имел в виду другое?"
4. WHEN сомнения возникли THEN он SHALL рассмотреть альтернативные интерпретации
5. WHEN альтернативы рассмотрены THEN он SHALL подтвердить или изменить классификацию

### Requirement 5: Планирование с самопроверкой для ActionPlannerAgent

**User Story:** Как пользователь системы, я хочу чтобы ActionPlannerAgent создавал оптимальные планы действий, чтобы мои задачи выполнялись эффективно.

#### Acceptance Criteria

1. WHEN ActionPlannerAgent получает задачу THEN он SHALL проанализировать сложность и требования
2. WHEN анализ завершен THEN он SHALL создать пошаговый план действий
3. WHEN план создан THEN он SHALL усомниться: "Это действительно оптимальный план?"
4. WHEN сомнения возникли THEN он SHALL проверить план на избыточность и пропуски
5. WHEN проверка завершена THEN он SHALL оптимизировать план или подтвердить его корректность

### Requirement 6: Логирование процесса самоанализа

**User Story:** Как разработчик системы, я хочу видеть процесс мышления агентов, чтобы понимать как они принимают решения и отлаживать проблемы.

#### Acceptance Criteria

1. WHEN агент начинает анализ THEN он SHALL логировать этап "Анализ задачи"
2. WHEN агент создает решение THEN он SHALL логировать этап "Создание решения"
3. WHEN агент сомневается THEN он SHALL логировать этап "Самопроверка"
4. WHEN агент улучшает решение THEN он SHALL логировать этап "Улучшение"
5. WHEN процесс завершен THEN он SHALL логировать финальное решение с обоснованием

### Requirement 7: Обработка ошибок в процессе самоанализа

**User Story:** Как пользователь системы, я хочу чтобы система работала стабильно даже если процесс самоанализа агентов дает сбой, чтобы получить результат в любом случае.

#### Acceptance Criteria

1. WHEN процесс самоанализа дает сбой THEN система SHALL использовать fallback к простому решению
2. WHEN агент не может улучшить решение THEN он SHALL использовать первоначальное решение
3. WHEN время выполнения превышает лимит THEN агент SHALL прервать самоанализ и вернуть текущее решение
4. WHEN возникает ошибка парсинга THEN агент SHALL попытаться исправить ошибку или использовать резервный метод
5. WHEN все попытки исчерпаны THEN система SHALL вернуть ошибку с понятным объяснением

### Requirement 8: Конфигурируемость процесса самоанализа

**User Story:** Как администратор системы, я хочу иметь возможность настраивать глубину самоанализа агентов, чтобы балансировать между качеством и скоростью работы.

#### Acceptance Criteria

1. WHEN система запускается THEN она SHALL загрузить настройки самоанализа из конфигурации
2. WHEN настройка "enable_self_reflection" = false THEN агенты SHALL работать в простом режиме
3. WHEN настройка "reflection_depth" установлена THEN агенты SHALL ограничить количество итераций самопроверки
4. WHEN настройка "max_reflection_time" установлена THEN агенты SHALL ограничить время на самоанализ
5. WHEN конфигурация изменена THEN система SHALL применить новые настройки без перезапуска